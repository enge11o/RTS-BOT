(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const z={fromPoints(n,t){const e=Math.min(n.x,t.x),i=Math.min(n.y,t.y);return{x:e,y:i,w:Math.abs(n.x-t.x),h:Math.abs(n.y-t.y)}},contains(n,t){return t.x>=n.x&&t.y>=n.y&&t.x<=n.x+n.w&&t.y<=n.y+n.h},intersectsCircle(n,t,e){const i=Math.max(n.x,Math.min(t.x,n.x+n.w)),s=Math.max(n.y,Math.min(t.y,n.y+n.h)),o=t.x-i,a=t.y-s;return o*o+a*a<=e*e}};class _{width;height;nodes;constructor(t,e){this.width=t,this.height=e,this.nodes=new Array(t*e).fill(0).map((i,s)=>({x:s%t,y:Math.floor(s/t),walkable:!0}))}idx(t,e){return e*this.width+t}inBounds(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}setBlocked(t,e,i){this.inBounds(t,e)&&(this.nodes[this.idx(t,e)].walkable=!i)}isWalkable(t,e){return this.inBounds(t,e)&&this.nodes[this.idx(t,e)].walkable}}function F(n,t,e){const i=Math.round(t.x),s=Math.round(t.y),o=Math.round(e.x),a=Math.round(e.y);if(!n.inBounds(i,s)||!n.inBounds(o,a))return[];const l=[],r=new Map,d=new Map,u=new Map,c=n.idx(i,s);l.push(c),d.set(c,0),u.set(c,$(i,s,o,a));const h=new Set;for(;l.length;){let p=0;for(let m=1;m<l.length;m++)(u.get(l[m])??1/0)<(u.get(l[p])??1/0)&&(p=m);const f=l.splice(p,1)[0];if(f===n.idx(o,a))return J(n,r,f);h.add(f);const N=f%n.width,W=Math.floor(f/n.width);for(const[m,C]of V(n,N,W)){const b=n.idx(m,C);if(h.has(b)||!n.isWalkable(m,C))continue;const I=(d.get(f)??1/0)+Z(N,W,m,C);if(!l.includes(b))l.push(b);else if(I>=(d.get(b)??1/0))continue;r.set(b,f),d.set(b,I),u.set(b,I+$(m,C,o,a))}}return[]}function J(n,t,e){const i=[];for(;t.has(e);){const s=e%n.width,o=Math.floor(e/n.width);i.push({x:s,y:o}),e=t.get(e)}return i.reverse(),i.length>1&&tt(i),i}function V(n,t,e){const i=[];for(let s=-1;s<=1;s++)for(let o=-1;o<=1;o++){if(o===0&&s===0)continue;const a=t+o,l=e+s;n.inBounds(a,l)&&n.isWalkable(a,l)&&(o!==0&&s!==0&&(!n.isWalkable(t+o,e)||!n.isWalkable(t,e+s))||i.push([a,l]))}return i}function $(n,t,e,i){const s=Math.abs(n-e),o=Math.abs(t-i);return s+o+(Math.SQRT2-2)*Math.min(s,o)}function Z(n,t,e,i){return Math.hypot(e-n,i-t)}function tt(n){for(let t=n.length-3;t>=0;t--){const e=n[t],i=n[t+1],s=n[t+2],o=i.x-e.x,a=i.y-e.y,l=s.x-i.x,r=s.y-i.y;o===l&&a===r&&n.splice(t+1,1)}}let k=1;class Q{width;height;tileSize=16;nav;entities=[];effects=[];economy={rubles:500,dollars:200,supplyCap:10,supplyUsed:0};time=0;playerFaction="SBEU";missionName="";objectiveText="Песочница";onUpdateExtra;winCondition;loseCondition;state="running";catalog={"sbeu-worker":{id:"sbeu-worker",label:"Дикий (рабочий)",costRubles:50,costDollars:0,buildTime:4,tier:1,supplyCost:1},"sbeu-worm":{id:"sbeu-worm",label:"СБЭУ-Червь",costRubles:50,costDollars:0,buildTime:6,tier:1,supplyCost:1},"sbeu-caterpillar":{id:"sbeu-caterpillar",label:"СБЭУ-Гусеница",costRubles:75,costDollars:0,buildTime:7,tier:1,supplyCost:1},"sbeu-cockroach":{id:"sbeu-cockroach",label:"СБЭУ-Таракан",costRubles:125,costDollars:25,buildTime:10,tier:2,supplyCost:2},"sbeu-cicada":{id:"sbeu-cicada",label:"СБЭУ-Цикада",costRubles:100,costDollars:50,buildTime:12,tier:2,supplyCost:2},"sbeu-turtle":{id:"sbeu-turtle",label:"СБЭУ-Черепаха",costRubles:250,costDollars:100,buildTime:20,tier:3,supplyCost:3},"pmc-typok":{id:"pmc-typok",label:"Типок",costRubles:50,costDollars:0,buildTime:6,tier:1,supplyCost:1},"pmc-silach":{id:"pmc-silach",label:"Силач",costRubles:100,costDollars:0,buildTime:9,tier:2,supplyCost:2},"pmc-sniper":{id:"pmc-sniper",label:"Снайпер",costRubles:125,costDollars:50,buildTime:12,tier:2,supplyCost:2},"pmc-grenade":{id:"pmc-grenade",label:"Грената",costRubles:100,costDollars:75,buildTime:14,tier:2,supplyCost:2},"pmc-tank":{id:"pmc-tank",label:"Танк",costRubles:300,costDollars:150,buildTime:25,tier:3,supplyCost:4}};buildingCatalog={stash:{id:"stash",label:"Ячейка схрона",costRubles:100,costDollars:0,buildTime:8,radius:4,supplyBonus:8},"pmc-supply":{id:"pmc-supply",label:"Центр поставок",costRubles:150,costDollars:50,buildTime:12,radius:5,incomeKind:"dollars",incomePerSec:4,incomeRadius:8}};constructor(t,e){this.width=t,this.height=e,this.nav=new _(t,e)}blockTilesForCircle(t,e,i=!0){const s=Math.ceil(e);for(let o=-s;o<=s;o++)for(let a=-s;a<=s;a++){const l=Math.floor(t.x+a),r=Math.floor(t.y+o);a*a+o*o<=s*s&&this.nav.setBlocked(l,r,i)}}canPlaceBuilding(t,e){const i=this.buildingCatalog[t];if(!i)return!1;const s=i.radius+1;for(let o=-s;o<=s;o++)for(let a=-s;a<=s;a++){const l=Math.floor(e.x+a),r=Math.floor(e.y+o);if(a*a+o*o<=s*s&&(!this.nav.inBounds(l,r)||!this.nav.isWalkable(l,r)))return!1}for(const o of this.entities)if(Math.hypot(o.pos.x-e.x,o.pos.y-e.y)<o.radius+i.radius+1)return!1;return!0}placeBuilding(t,e,i){const s=this.buildingCatalog[e];if(!s||!this.canPlaceBuilding(e,i)||this.economy.rubles<s.costRubles||this.economy.dollars<s.costDollars)return null;this.economy.rubles-=s.costRubles,this.economy.dollars-=s.costDollars;const o={id:k++,name:s.label,type:"building",faction:t,pos:{...i},radius:s.radius,hp:800,hpMax:800,tier:1,buildingType:e,underConstruction:!0,constructRemaining:s.buildTime,supplyBonus:s.supplyBonus};return this.entities.push(o),this.blockTilesForCircle(o.pos,o.radius+1,!0),o}spawnDemo(){const t={id:k++,name:"Улей",type:"building",faction:"SBEU",pos:{x:40,y:40},radius:6,hp:1500,hpMax:1500,tier:1,trainQueue:[],garrison:0};this.entities.push(t),this.blockTilesForCircle(t.pos,t.radius+1);for(let i=0;i<6;i++){const s=this.spawnUnit("SBEU",{x:52+i*2,y:40},"sbeu-worker");s.carryRubles=0,s.carryCapacity=15,s.harvestCooldown=0}for(let i=0;i<12;i++){const s=this.spawnResource({x:70+i%6*3,y:32+Math.floor(i/6)*3},"rubles",1500);this.blockTilesForCircle(s.pos,s.radius+1)}for(let i=0;i<8;i++){const s=this.spawnResource({x:64+i%4*3,y:48+Math.floor(i/4)*3},"dollars",800);this.blockTilesForCircle(s.pos,s.radius+1)}const e={id:k++,name:"Центр поставок",type:"building",faction:"PMС",pos:{x:96,y:88},radius:5,hp:1200,hpMax:1200,tier:1,trainQueue:[],garrison:0,buildingType:"pmc-supply",underConstruction:!1};this.entities.push(e),this.blockTilesForCircle(e.pos,e.radius+1);for(let i=0;i<4;i++)this.spawnUnit("PMС",{x:90+i*2,y:96},"pmc-typok");this.objectiveText="Песочница: стройте юнитов и тестируйте управление"}spawnResource(t,e,i){const s={id:k++,name:e==="rubles"?"Рубли":"Доллары",type:"resource",faction:"NEUTRAL",pos:t,radius:3,hp:1,hpMax:1,resource:{kind:e,amount:i}};return this.entities.push(s),s}spawnUnit(t,e,i){const s=this.catalog[i],o={id:k++,name:s.label,type:"unit",faction:t,pos:{...e},radius:2.8,hp:100,hpMax:100,moveSpeed:7,supplyCost:s.supplyCost,attack:{range:8,damage:6,cooldown:1,cd:0}};return(i==="sbeu-turtle"||i==="pmc-tank")&&(o.radius=4,o.hp=260,o.hpMax=260,o.moveSpeed=4,o.attack={range:10,damage:14,cooldown:1.5,cd:0,splash:i==="pmc-tank"?2.5:void 0}),i==="pmc-sniper"&&(o.attack={range:16,damage:6,cooldown:1.2,cd:0},o.abilities={aimedShot:{cd:0,cooldown:5,bonusDamage:30}}),i==="pmc-grenade"&&(o.attack={range:10,damage:4,cooldown:2,cd:0},o.abilities={throwGrenade:{cd:0,cooldown:10,fuse:2,radius:3,damage:32,range:12}}),i==="sbeu-cicada"&&(o.attack={range:9,damage:3,cooldown:1,cd:0},o.abilities={stunGrenade:{cd:0,cooldown:12,radius:3.5,duration:2.5,range:11}}),this.entities.push(o),o}getEntityById(t){return this.entities.find(e=>e.id===t)}queryEntities(t){const e=[];for(const i of this.entities)i.type!=="resource"&&z.intersectsCircle(t,i.pos,i.radius)&&e.push(i.id);return e}pickEntity(t,e){for(let i=this.entities.length-1;i>=0;i--){const s=this.entities[i],o=t-s.pos.x,a=e-s.pos.y;if(o*o+a*a<=s.radius*s.radius)return s}return null}issueMoveCommand(t,e){const i=[],o=t.length;let a=0,l=0;for(;l<o;){const d=Math.max(6,a*8);for(let u=0;u<d&&l<o;u++){const c=u/d*Math.PI*2,h=2.5*(a+1);i.push({x:Math.cos(c)*h,y:Math.sin(c)*h}),l++}a++}const r={x:Math.floor(e.x),y:Math.floor(e.y)};t.forEach((d,u)=>{const c=this.getEntityById(d);if(!c||c.type!=="unit"||!c.moveSpeed)return;const h={x:Math.floor(c.pos.x),y:Math.floor(c.pos.y)},p={x:r.x+Math.floor(i[u].x),y:r.y+Math.floor(i[u].y)},f=F(this.nav,h,p);c.path=f,c.pathIndex=0,c.targetPos={...p},c.lastPosX=c.pos.x,c.lastPosY=c.pos.y,c.stuckTime=0})}getEconomy(){let t=0;for(const e of this.entities)e.type==="unit"&&e.faction===this.playerFaction&&(t+=e.supplyCost??0);return this.economy.supplyUsed=t,this.economy}getTrainableUnits(t,e){const i=[];for(const s of Object.values(this.catalog))s.id.startsWith("sbeu")&&t!=="SBEU"||s.id.startsWith("pmc")&&t!=="PMС"||e&&s.tier>e||i.push(s);return i}queueTrain(t,e){const i=this.getEntityById(t);if(!i||i.type!=="building")return;const s=this.catalog[e];if(!s)return;const{supplyUsed:o,supplyCap:a}=this.getEconomy();o+s.supplyCost>a||this.economy.rubles<s.costRubles||this.economy.dollars<s.costDollars||(this.economy.rubles-=s.costRubles,this.economy.dollars-=s.costDollars,i.trainQueue=i.trainQueue||[],i.trainQueue.push(e))}processTraining(t){for(const e of this.entities){if(e.type!=="building"||!e.trainQueue||e.trainQueue.length===0)continue;const i=e.trainQueue[0],s=this.catalog[i];e.garrison=(e.garrison??0)+t,e.garrison>=s.buildTime&&(e.garrison=0,e.trainQueue.shift(),this.spawnUnit(e.faction,{x:e.pos.x+8+Math.random()*4,y:e.pos.y+(Math.random()*6-3)},i))}}harvestAndIncome(t){for(const e of this.entities)if(e.type==="unit"&&e.faction==="SBEU"&&e.name.includes("Дикий")){e.harvestCooldown=Math.max(0,(e.harvestCooldown??0)-t);const i=this.entities.find(o=>o.type==="building"&&o.faction==="SBEU"&&o.name==="Улей"),s=this.entities.find(o=>o.type==="resource"&&o.resource?.kind==="rubles"&&o.resource.amount>0&&y(e.pos,o.pos)<10);if((e.carryRubles??0)>=(e.carryCapacity??15))i&&(y(e.pos,i.pos)>6?this.issueMoveCommand([e.id],i.pos):(this.economy.rubles+=e.carryRubles??0,e.carryRubles=0));else if(s&&e.harvestCooldown===0){const o=Math.min(2,s.resource.amount);s.resource.amount-=o,e.carryRubles=(e.carryRubles??0)+o,e.harvestCooldown=1}}for(const e of this.entities){if(e.type!=="building"||e.faction!=="PMС"||e.buildingType!=="pmc-supply"||e.underConstruction)continue;const i=this.buildingCatalog["pmc-supply"];if(!i.incomeKind||!i.incomePerSec||!i.incomeRadius)continue;const s=this.entities.filter(l=>l.type==="resource"&&l.resource?.kind==="dollars"&&y(l.pos,e.pos)<=i.incomeRadius);if(s.length===0)continue;let a=i.incomePerSec*t;for(const l of s){if(a<=0)break;const r=Math.min(a,l.resource.amount);l.resource.amount-=r,a-=r,this.economy.dollars+=r}}}updateEffects(t){for(const i of this.effects)i.fuse-=t;const e=this.effects.filter(i=>i.fuse<=0);this.effects=this.effects.filter(i=>i.fuse>0);for(const i of e)if(i.kind==="explosion")for(const s of this.entities)s.faction===i.faction||s.faction==="NEUTRAL"||y(s.pos,i.pos)<=i.radius&&(s.hp-=i.damage);else if(i.kind==="stun")for(const s of this.entities)s.faction!=="NEUTRAL"&&y(s.pos,i.pos)<=i.radius&&(s.stunnedUntil=Math.max(s.stunnedUntil??0,this.time+i.duration))}useAbilities(t){for(const e of this.entities){if(e.type!=="unit"||!e.abilities||(e.stunnedUntil??0)>this.time)continue;const i=this.entities.find(o=>o.faction!==e.faction&&o.faction!=="NEUTRAL"&&o.hp>0);if(!i)continue;const s=y(e.pos,i.pos);if(e.abilities.stunGrenade){const o=e.abilities.stunGrenade;o.cd=Math.max(0,o.cd-t),o.cd===0&&s<=o.range&&(this.effects.push({kind:"stun",pos:{...i.pos},fuse:.1,radius:o.radius,duration:o.duration}),o.cd=o.cooldown)}if(e.abilities.aimedShot){const o=e.abilities.aimedShot;o.cd=Math.max(0,o.cd-t),o.cd===0&&e.attack&&s<=e.attack.range&&(i.hp-=o.bonusDamage,o.cd=o.cooldown)}if(e.abilities.throwGrenade){const o=e.abilities.throwGrenade;o.cd=Math.max(0,o.cd-t),o.cd===0&&s<=o.range&&(this.effects.push({kind:"explosion",pos:{...i.pos},fuse:o.fuse,radius:o.radius,damage:o.damage,faction:e.faction}),o.cd=o.cooldown)}}}manualCastAbility(t,e,i){const s=this.getEntityById(t);if(!(!s||s.type!=="unit"||!s.abilities)){if(e==="stunGrenade"&&s.abilities.stunGrenade){const o=s.abilities.stunGrenade;o.cd===0&&(this.effects.push({kind:"stun",pos:{...i},fuse:.05,radius:o.radius,duration:o.duration}),o.cd=o.cooldown)}if(e==="aimedShot"&&s.abilities.aimedShot){const o=s.abilities.aimedShot;if(o.cd===0){const a=this.entities.find(l=>l.faction!==s.faction&&l.faction!=="NEUTRAL"&&y(l.pos,i)<4);a&&(a.hp-=o.bonusDamage),o.cd=o.cooldown}}if(e==="throwGrenade"&&s.abilities.throwGrenade){const o=s.abilities.throwGrenade;o.cd===0&&(this.effects.push({kind:"explosion",pos:{...i},fuse:o.fuse,radius:o.radius,damage:o.damage,faction:s.faction}),o.cd=o.cooldown)}}}update(t){if(this.state!=="running")return;this.time+=t;for(const i of this.entities){if(i.type!=="unit"||!i.moveSpeed)continue;let s=0,o=0,a=0;for(const l of this.entities){if(l===i||l.type!=="unit"||l.faction!==i.faction)continue;const r=i.pos.x-l.pos.x,d=i.pos.y-l.pos.y,u=r*r+d*d,c=i.radius+l.radius+1;if(u<c*c&&u>1e-4){const h=Math.sqrt(u);s+=r/h,o+=d/h,a++}}a&&(i.pos.x+=s/a*2*t,i.pos.y+=o/a*2*t)}for(const i of this.entities)if(!(i.type!=="unit"||!i.moveSpeed)&&!((i.stunnedUntil??0)>this.time)&&i.path&&i.pathIndex<i.path.length){const s=i.path[i.pathIndex],o={x:s.x,y:s.y},a=o.x-i.pos.x,l=o.y-i.pos.y,r=Math.hypot(a,l);if(r<.2)i.pathIndex++;else{const h=a/(r||1),p=l/(r||1);i.pos.x+=h*i.moveSpeed*t,i.pos.y+=p*i.moveSpeed*t}const d=i.lastPosX??i.pos.x,u=i.lastPosY??i.pos.y,c=Math.hypot(i.pos.x-d,i.pos.y-u);if(i.stuckTime=(i.stuckTime??0)+t,c>.3)i.lastPosX=i.pos.x,i.lastPosY=i.pos.y,i.stuckTime=0;else if(i.stuckTime>1&&i.targetPos){const h={x:Math.floor(i.pos.x),y:Math.floor(i.pos.y)},p={x:Math.floor(i.targetPos.x),y:Math.floor(i.targetPos.y)};i.path=F(this.nav,h,p),i.pathIndex=0,i.stuckTime=0}}this.useAbilities(t);for(const i of this.entities){if(!i.attack)continue;if((i.stunnedUntil??0)>this.time){i.attack.cd=Math.max(0,i.attack.cd-t);continue}i.attack.cd=Math.max(0,i.attack.cd-t);const s=this.entities.find(o=>o.faction!==i.faction&&o.faction!=="NEUTRAL"&&o.hp>0&&y(i.pos,o.pos)<=i.attack.range);if(s&&i.attack.cd<=0){if(s.hp-=i.attack.damage,i.attack.splash)for(const o of this.entities)o!==s&&(o.faction===i.faction||o.faction==="NEUTRAL"||y(o.pos,s.pos)<=i.attack.splash&&(o.hp-=Math.max(1,Math.floor(i.attack.damage*.4))));i.attack.cd=i.attack.cooldown}}this.updateEffects(t);for(const i of this.entities)i.type==="building"&&i.underConstruction&&(i.constructRemaining=Math.max(0,(i.constructRemaining??0)-t),i.constructRemaining===0&&(i.underConstruction=!1,i.supplyBonus&&(this.economy.supplyCap+=i.supplyBonus)));this.entities=this.entities.filter(i=>i.hp>0||i.type==="resource"),this.processTraining(t),this.harvestAndIncome(t),this.onUpdateExtra&&this.onUpdateExtra(this,t),this.winCondition&&this.winCondition(this)&&(this.state="victory");const e=()=>this.entities.every(i=>i.faction!==this.playerFaction||i.type!=="unit"&&i.type!=="building");(this.loseCondition&&this.loseCondition(this)||e())&&(this.state="defeat")}getState(){return this.state}render(t){t.save(),t.strokeStyle="#0f172a",t.lineWidth=1;for(let e=0;e<=this.height;e+=8)t.beginPath(),t.moveTo(0,e),t.lineTo(this.width,e),t.stroke();for(let e=0;e<=this.width;e+=8)t.beginPath(),t.moveTo(e,0),t.lineTo(e,this.height),t.stroke();for(const e of this.effects)e.kind==="explosion"?(t.strokeStyle="rgba(239,68,68,0.6)",t.beginPath(),t.arc(e.pos.x,e.pos.y,e.radius,0,Math.PI*2),t.stroke()):e.kind==="stun"&&(t.strokeStyle="rgba(96,165,250,0.6)",t.beginPath(),t.arc(e.pos.x,e.pos.y,e.radius,0,Math.PI*2),t.stroke());for(const e of this.entities)e.type==="resource"&&(t.fillStyle=e.resource.kind==="rubles"?"#3b82f6":"#22c55e",t.beginPath(),t.arc(e.pos.x,e.pos.y,2.5,0,Math.PI*2),t.fill());for(const e of this.entities)if(e.type==="building"){if(t.fillStyle=e.faction==="SBEU"?"#9333ea":"#ef4444",t.fillRect(e.pos.x-e.radius,e.pos.y-e.radius,e.radius*2,e.radius*2),e.underConstruction&&(t.fillStyle="rgba(248,113,113,0.3)",t.fillRect(e.pos.x-e.radius,e.pos.y-e.radius,e.radius*2,e.radius*2)),e.faction==="PMС"&&e.buildingType==="pmc-supply"){const i=this.buildingCatalog["pmc-supply"];i.incomeRadius&&(t.strokeStyle="rgba(34,197,94,0.35)",t.beginPath(),t.arc(e.pos.x,e.pos.y,i.incomeRadius,0,Math.PI*2),t.stroke())}G(t,e)}for(const e of this.entities)if(e.type==="unit"){const i=(e.stunnedUntil??0)>this.time;t.fillStyle=e.faction==="SBEU"?"#a78bfa":"#f87171",t.globalAlpha=i?.6:1,t.beginPath(),t.arc(e.pos.x,e.pos.y,e.radius,0,Math.PI*2),t.fill(),t.globalAlpha=1,G(t,e)}t.restore()}}function G(n,t){const s=t.pos.x-6,o=t.pos.y-(t.type==="building"?t.radius+4:t.radius+6);n.fillStyle="#111827",n.fillRect(s,o,12,2);const a=Math.max(0,Math.min(1,t.hp/t.hpMax));n.fillStyle=a>.6?"#22c55e":a>.3?"#eab308":"#ef4444",n.fillRect(s,o,12*a,2)}function y(n,t){return Math.hypot(n.x-t.x,n.y-t.y)}class et{canvas;ctx;world;camera={x:0,y:0,zoom:1};mouse={x:0,y:0,worldX:0,worldY:0,down:!1};selectionStart=null;selectedIds=new Set;pendingAbility=null;buildPlacer=null;groups={};constructor(t,e){this.canvas=t,this.ctx=e,this.world=new Q(128,128),this.world.spawnDemo(),this.bindInput()}loadWorld(t){this.world=t,this.selectedIds.clear(),this.camera={x:0,y:0,zoom:1},this.pendingAbility=null,this.buildPlacer=null}getWorldState(){return this.world.getState()}bindInput(){this.canvas.addEventListener("mousemove",t=>{const e=this.canvas.getBoundingClientRect();this.mouse.x=t.clientX-e.left,this.mouse.y=t.clientY-e.top,this.mouse.worldX=this.mouse.x/this.camera.zoom+this.camera.x,this.mouse.worldY=this.mouse.y/this.camera.zoom+this.camera.y}),this.canvas.addEventListener("mousedown",t=>{t.button===0&&(this.mouse.down=!0,this.selectionStart={x:this.mouse.worldX,y:this.mouse.worldY})}),window.addEventListener("mouseup",t=>{if(t.button===0){if(this.mouse.down=!1,this.pendingAbility){this.world.manualCastAbility(this.pendingAbility.casterId,this.pendingAbility.kind,{x:this.mouse.worldX,y:this.mouse.worldY}),this.pendingAbility=null,this.selectionStart=null;return}if(this.buildPlacer){this.world.placeBuilding(this.world.playerFaction,this.buildPlacer.typeId,{x:this.mouse.worldX,y:this.mouse.worldY}),this.buildPlacer=null,this.selectionStart=null;return}this.commitSelection(),this.selectionStart=null}}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.canvas.addEventListener("mouseup",t=>{if(t.button===2){if(this.pendingAbility||this.buildPlacer){this.pendingAbility=null,this.buildPlacer=null;return}const e={x:this.mouse.worldX,y:this.mouse.worldY};this.world.issueMoveCommand([...this.selectedIds],e)}}),window.addEventListener("keydown",t=>{(t.key==="ArrowUp"||t.key==="w")&&(this.camera.y-=32),(t.key==="ArrowDown"||t.key==="s")&&(this.camera.y+=32),(t.key==="ArrowLeft"||t.key==="a")&&(this.camera.x-=32),(t.key==="ArrowRight"||t.key==="d")&&(this.camera.x+=32);const i=parseInt(t.key,10);if(!isNaN(i)&&i>=1&&i<=9)if(t.ctrlKey||t.metaKey)this.groups[i]=[...this.selectedIds];else{const s=this.groups[i]||[];this.selectedIds=new Set(s)}if(t.key.toLowerCase()==="q"||t.key.toLowerCase()==="w"||t.key.toLowerCase()==="e"){const s=[...this.selectedIds].map(o=>this.world.getEntityById(o)).find(o=>o?.type==="unit"&&o.abilities);s&&s?.abilities&&(t.key.toLowerCase()==="q"&&s.abilities.stunGrenade&&(this.pendingAbility={casterId:s.id,kind:"stunGrenade"}),t.key.toLowerCase()==="w"&&s.abilities.aimedShot&&(this.pendingAbility={casterId:s.id,kind:"aimedShot"}),t.key.toLowerCase()==="e"&&s.abilities.throwGrenade&&(this.pendingAbility={casterId:s.id,kind:"throwGrenade"}))}t.key.toLowerCase()==="b"&&(this.buildPlacer={typeId:"stash"}),t.key.toLowerCase()==="c"&&(this.buildPlacer={typeId:"pmc-supply"})}),this.canvas.addEventListener("wheel",t=>{const e=t.deltaY>0?.9:1.1,i=this.screenToWorld(this.mouse.x,this.mouse.y);this.camera.zoom=Math.max(.5,Math.min(2,this.camera.zoom*e));const s=this.screenToWorld(this.mouse.x,this.mouse.y);this.camera.x+=i.x-s.x,this.camera.y+=i.y-s.y},{passive:!0})}screenToWorld(t,e){return{x:t/this.camera.zoom+this.camera.x,y:e/this.camera.zoom+this.camera.y}}commitSelection(){if(!this.selectionStart){const i=this.world.pickEntity(this.mouse.worldX,this.mouse.worldY);this.selectedIds.clear(),i&&this.selectedIds.add(i.id);return}const t=z.fromPoints(this.selectionStart,{x:this.mouse.worldX,y:this.mouse.worldY}),e=this.world.queryEntities(t);this.selectedIds=new Set(e)}update(t){this.world.update(t)}render(){const{ctx:t}=this;if(t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.scale(this.camera.zoom,this.camera.zoom),t.translate(-this.camera.x,-this.camera.y),this.world.render(t),this.mouse.down&&this.selectionStart&&!this.pendingAbility&&!this.buildPlacer){const e=Math.min(this.selectionStart.x,this.mouse.worldX),i=Math.min(this.selectionStart.y,this.mouse.worldY),s=Math.abs(this.selectionStart.x-this.mouse.worldX),o=Math.abs(this.selectionStart.y-this.mouse.worldY);t.strokeStyle="#60a5fa",t.lineWidth=1,t.strokeRect(e,i,s,o)}if(this.pendingAbility&&(t.strokeStyle="#f59e0b",t.beginPath(),t.arc(this.mouse.worldX,this.mouse.worldY,3,0,Math.PI*2),t.stroke()),this.buildPlacer){const e=this.buildPlacer.typeId,i=this.world.canPlaceBuilding(e,{x:this.mouse.worldX,y:this.mouse.worldY});t.strokeStyle=i?"#22c55e":"#ef4444",t.lineWidth=2;const s=this.world.buildingCatalog[e].radius;t.strokeRect(this.mouse.worldX-s,this.mouse.worldY-s,s*2,s*2)}for(const e of this.selectedIds){const i=this.world.getEntityById(e);i&&(t.strokeStyle="#34d399",t.lineWidth=2,t.beginPath(),t.arc(i.pos.x,i.pos.y,i.radius+2,0,Math.PI*2),t.stroke())}t.restore()}getUIState(){const t=this.world.getEconomy(),e=[...this.selectedIds].map(o=>this.world.getEntityById(o)).filter(Boolean),i=e.length===1?`${e[0].name} (HP ${Math.ceil(e[0].hp)})`:e.length>1?`${e.length} юнитов`:"—",s=[];if(e.length===1&&e[0].type==="building"){const o=e[0];for(const a of this.world.getTrainableUnits(o.faction,o.tier))s.push({id:`train:${a.id}`,label:`Нанять ${a.label}`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>this.world.queueTrain(o.id,a.id)});if(o.faction===this.world.playerFaction){const a=this.world.buildingCatalog.stash;s.push({id:"build:stash",label:`Построить ${a.label} (B)`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>{this.buildPlacer={typeId:"stash"}}});const l=this.world.buildingCatalog["pmc-supply"];s.push({id:"build:pmc",label:`Построить ${l.label} (C)`,costRubles:l.costRubles,costDollars:l.costDollars,onClick:()=>{this.buildPlacer={typeId:"pmc-supply"}}})}}if(e.length===1&&e[0].type==="unit"){const o=e[0];if(o.faction===this.world.playerFaction){const a=this.world.buildingCatalog.stash;s.push({id:"build:stash",label:`Построить ${a.label} (B)`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>{this.buildPlacer={typeId:"stash"}}});const l=this.world.buildingCatalog["pmc-supply"];s.push({id:"build:pmc",label:`Построить ${l.label} (C)`,costRubles:l.costRubles,costDollars:l.costDollars,onClick:()=>{this.buildPlacer={typeId:"pmc-supply"}}})}o.abilities&&(o.abilities.stunGrenade&&s.push({id:`ab:stun:${o.id}`,label:"Оглушающая граната (Q)",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"stunGrenade"}}}),o.abilities.aimedShot&&s.push({id:`ab:aim:${o.id}`,label:"Прицельный выстрел (W)",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"aimedShot"}}}),o.abilities.throwGrenade&&s.push({id:`ab:nade:${o.id}`,label:"Кинуть гранату (E)",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"throwGrenade"}}}))}return{rubles:t.rubles,dollars:t.dollars,selectedCount:e.length,inspector:i,objective:this.world.objectiveText,supply:`${this.world.economy.supplyUsed}/${this.world.economy.supplyCap}`,actions:s}}}function g(n,t,e,i){for(const s of i)for(let o=0;o<s.count;o++)n.spawnUnit(t,{x:e.x+(Math.random()*6-3),y:e.y+(Math.random()*6-3)},s.unitId)}function P(n,t){n.objectiveText="Уничтожьте все силы противника",n.winCondition=e=>e.entities.every(i=>i.faction===t||i.faction==="NEUTRAL")}function B(n,t){const e=t*60;n.objectiveText=`Продержитесь ${t} минут`,n.winCondition=i=>i.time>=e}function it(n,t,e){n.objectiveText=`Накопите ресурсы: ₽${t} и $${e}`,n.winCondition=i=>i.getEconomy().rubles>=t&&i.getEconomy().dollars>=e}const v={SBEU:{id:"SBEU",name:"Кампания СБЭУ",missions:[{id:"sbeu-1",name:"Инструктаж зверинца",faction:"SBEU",setup:n=>{n.missionName="Инструктаж зверинца",n.playerFaction="SBEU",n.spawnDemo(),n.objectiveText="Выделяйте юнитов и отдавайте приказы. Постройте пару бойцов",n.winCondition=t=>t.entities.filter(e=>e.faction==="SBEU"&&e.type==="unit").length>=10}},{id:"sbeu-2",name:"Отбить ресурсные точки",faction:"SBEU",setup:n=>{n.missionName="Отбить ресурсные точки",n.playerFaction="SBEU",n.spawnDemo();for(const t of n.entities.filter(e=>e.type==="resource"))g(n,"PMС",{x:t.pos.x+6,y:t.pos.y+6},[{unitId:"pmc-typok",count:3}]);n.objectiveText="Очистите окрестности ресурсов",n.winCondition=t=>t.entities.every(e=>!(e.faction==="PMС"&&e.type==="unit"))}},{id:"sbeu-3",name:"Штурм укрепточки",faction:"SBEU",setup:n=>{n.missionName="Штурм укрепточки",n.playerFaction="SBEU",n.spawnDemo(),g(n,"PMС",{x:92,y:86},[{unitId:"pmc-silach",count:3},{unitId:"pmc-sniper",count:2}]),P(n,"SBEU")}},{id:"sbeu-4",name:"Накопить на штурм",faction:"SBEU",setup:n=>{n.missionName="Накопить на штурм",n.playerFaction="SBEU",n.spawnDemo(),it(n,1e3,300);let t=0;n.onUpdateExtra=(e,i)=>{t+=i,t>20&&(t=0,g(e,"PMС",{x:88,y:92},[{unitId:"pmc-typok",count:4},{unitId:"pmc-grenade",count:1}]))}}},{id:"sbeu-5",name:"Штурм водоочистной",faction:"SBEU",setup:n=>{n.missionName="Штурм водоочистной",n.playerFaction="SBEU",n.spawnDemo(),g(n,"PMС",{x:94,y:84},[{unitId:"pmc-silach",count:4},{unitId:"pmc-sniper",count:2},{unitId:"pmc-tank",count:1}]),P(n,"SBEU")}}]},PMC:{id:"PMC",name:"Кампания ЧВК",missions:[{id:"pmc-1",name:"Прибытие Зубешко",faction:"PMС",setup:n=>{n.missionName="Прибытие Зубешко",n.playerFaction="PMС",n.spawnDemo(),n.objectiveText="Инструктаж по механикам ЧВК",n.winCondition=t=>t.entities.filter(e=>e.faction==="PMС"&&e.type==="unit").length>=8}},{id:"pmc-2",name:"Оборона укрепления A",faction:"PMС",setup:n=>{n.missionName="Оборона укрепления A",n.playerFaction="PMС",n.spawnDemo(),B(n,3);let t=0;n.onUpdateExtra=(e,i)=>{t+=i,t>15&&(t=0,g(e,"SBEU",{x:60,y:30},[{unitId:"sbeu-worm",count:6},{unitId:"sbeu-caterpillar",count:2}]))}}},{id:"pmc-3",name:"Оборона укрепления B",faction:"PMС",setup:n=>{n.missionName="Оборона укрепления B",n.playerFaction="PMС",n.spawnDemo(),B(n,4);let t=0;n.onUpdateExtra=(e,i)=>{t+=i,t>18&&(t=0,g(e,"SBEU",{x:66,y:52},[{unitId:"sbeu-cockroach",count:3},{unitId:"sbeu-cicada",count:2}]))}}},{id:"pmc-4",name:"Предательство Пуссильченко",faction:"PMС",setup:n=>{n.missionName="Предательство Пуссильченко",n.playerFaction="PMС",n.spawnDemo(),B(n,5);let t=0;n.onUpdateExtra=(e,i)=>{t+=i,t>20&&(t=0,g(e,"SBEU",{x:70,y:46},[{unitId:"sbeu-worm",count:6},{unitId:"sbeu-cockroach",count:4},{unitId:"sbeu-turtle",count:1}]))}}},{id:"pmc-5",name:"Контрнаступление",faction:"PMС",setup:n=>{n.missionName="Контрнаступление",n.playerFaction="PMС",n.spawnDemo(),P(n,"PMС")}}]}};function st(n,t){const i=v[n].missions[t],s=new Q(128,128);return s.playerFaction=i.faction,s.missionName=i.name,i.setup(s),s}const M=document.getElementById("game"),q=M.getContext("2d");function O(){const n=Math.max(1,Math.min(2,window.devicePixelRatio||1));M.width=Math.floor(window.innerWidth*n),M.height=Math.floor(window.innerHeight*n),M.style.width=`${window.innerWidth}px`,M.style.height=`${window.innerHeight}px`,q.setTransform(n,0,0,n,0,0)}O();window.addEventListener("resize",O);const w=new et(M,q),R=document.getElementById("mainMenu"),T=document.getElementById("missionMenu"),E=document.getElementById("resultMenu"),ot=document.getElementById("missionCampaignTitle"),X=document.getElementById("missionButtons");let S="SBEU",H=0;function U(n){n.style.display="flex"}function x(n){n.style.display="none"}function D(){U(R),x(T),x(E)}function A(n){S=n,ot.textContent=v[n].name,X.innerHTML="",v[n].missions.forEach((t,e)=>{const i=document.createElement("div");i.className="btn",i.textContent=`${e+1}. ${t.name}`,i.onclick=()=>L(n,e),X.appendChild(i)}),x(R),U(T),x(E)}function L(n,t){S=n,H=t,w.loadWorld(st(n,t)),x(R),x(T),x(E)}function nt(){L(S,H)}document.getElementById("btnPlaySBEU").onclick=()=>A("SBEU");document.getElementById("btnPlayPMC").onclick=()=>A("PMC");document.getElementById("btnSandbox").onclick=()=>{L("SBEU",0)};document.getElementById("btnBackToMain").onclick=()=>D();document.getElementById("btnRestart").onclick=()=>nt();document.getElementById("btnMissionSelect").onclick=()=>A(S);document.getElementById("btnMainMenu").onclick=()=>D();D();let Y=performance.now();function K(n){const t=Math.min(.05,(n-Y)/1e3);Y=n,w.update(t),w.render();const e=w.getWorldState?w.getWorldState():w.world?.getState?.();if(e==="victory"||e==="defeat"){const i=document.getElementById("resultTitle");i.textContent=e==="victory"?"Победа!":"Поражение",U(E)}requestAnimationFrame(K)}requestAnimationFrame(K);const at=document.getElementById("rubles"),lt=document.getElementById("dollars"),ct=document.getElementById("supply"),rt=document.getElementById("selected"),ut=document.getElementById("inspector"),j=document.getElementById("actions");function dt(){const n=w.getUIState();at.textContent=String(n.rubles),lt.textContent=String(n.dollars),ct.textContent=n.supply??"0/0",rt.textContent=String(n.selectedCount),ut.textContent=n.inspector+(n.objective?` | Цель: ${n.objective}`:""),j.innerHTML="";for(const t of n.actions){const e=document.createElement("div");e.className="btn",e.textContent=`${t.label} (${t.costRubles}₽/${t.costDollars}$)`,e.onclick=()=>t.onClick(),j.appendChild(e)}}setInterval(dt,120);
