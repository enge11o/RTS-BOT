(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const F={fromPoints(n,e){const t=Math.min(n.x,e.x),i=Math.min(n.y,e.y);return{x:t,y:i,w:Math.abs(n.x-e.x),h:Math.abs(n.y-e.y)}},contains(n,e){return e.x>=n.x&&e.y>=n.y&&e.x<=n.x+n.w&&e.y<=n.y+n.h},intersectsCircle(n,e,t){const i=Math.max(n.x,Math.min(e.x,n.x+n.w)),s=Math.max(n.y,Math.min(e.y,n.y+n.h)),o=e.x-i,a=e.y-s;return o*o+a*a<=t*t}};class N{width;height;nodes;constructor(e,t){this.width=e,this.height=t,this.nodes=new Array(e*t).fill(0).map((i,s)=>({x:s%e,y:Math.floor(s/e),walkable:!0}))}idx(e,t){return t*this.width+e}inBounds(e,t){return e>=0&&t>=0&&e<this.width&&t<this.height}setBlocked(e,t,i){this.inBounds(e,t)&&(this.nodes[this.idx(e,t)].walkable=!i)}isWalkable(e,t){return this.inBounds(e,t)&&this.nodes[this.idx(e,t)].walkable}}function U(n,e,t){const i=Math.round(e.x),s=Math.round(e.y),o=Math.round(t.x),a=Math.round(t.y);if(!n.inBounds(i,s)||!n.inBounds(o,a))return[];const l=[],r=new Map,d=new Map,u=new Map,c=n.idx(i,s);l.push(c),d.set(c,0),u.set(c,D(i,s,o,a));const h=new Set;for(;l.length;){let g=0;for(let f=1;f<l.length;f++)(u.get(l[f])??1/0)<(u.get(l[g])??1/0)&&(g=f);const p=l.splice(g,1)[0];if(p===n.idx(o,a))return j(n,r,p);h.add(p);const B=p%n.width,T=Math.floor(p/n.width);for(const[f,k]of z(n,B,T)){const y=n.idx(f,k);if(h.has(y)||!n.isWalkable(f,k))continue;const S=(d.get(p)??1/0)+Q(B,T,f,k);if(!l.includes(y))l.push(y);else if(S>=(d.get(y)??1/0))continue;r.set(y,p),d.set(y,S),u.set(y,S+D(f,k,o,a))}}return[]}function j(n,e,t){const i=[];for(;e.has(t);){const s=t%n.width,o=Math.floor(t/n.width);i.push({x:s,y:o}),t=e.get(t)}return i.reverse(),i.length>1&&q(i),i}function z(n,e,t){const i=[];for(let s=-1;s<=1;s++)for(let o=-1;o<=1;o++){if(o===0&&s===0)continue;const a=e+o,l=t+s;n.inBounds(a,l)&&n.isWalkable(a,l)&&(o!==0&&s!==0&&(!n.isWalkable(e+o,t)||!n.isWalkable(e,t+s))||i.push([a,l]))}return i}function D(n,e,t,i){const s=Math.abs(n-t),o=Math.abs(e-i);return s+o+(Math.SQRT2-2)*Math.min(s,o)}function Q(n,e,t,i){return Math.hypot(t-n,i-e)}function q(n){for(let e=n.length-3;e>=0;e--){const t=n[e],i=n[e+1],s=n[e+2],o=i.x-t.x,a=i.y-t.y,l=s.x-i.x,r=s.y-i.y;o===l&&a===r&&n.splice(e+1,1)}}let x=1;class W{width;height;tileSize=16;nav;entities=[];effects=[];economy={rubles:500,dollars:200,supplyCap:10,supplyUsed:0};time=0;playerFaction="SBEU";objectiveText="Песочница";onUpdateExtra;winCondition;loseCondition;catalog={"sbeu-worker":{id:"sbeu-worker",label:"Дикий (рабочий)",costRubles:50,costDollars:0,buildTime:4,tier:1,supplyCost:1},"sbeu-worm":{id:"sbeu-worm",label:"СБЭУ-Червь",costRubles:50,costDollars:0,buildTime:6,tier:1,supplyCost:1},"sbeu-caterpillar":{id:"sbeu-caterpillar",label:"СБЭУ-Гусеница",costRubles:75,costDollars:0,buildTime:7,tier:1,supplyCost:1},"sbeu-cockroach":{id:"sbeu-cockroach",label:"СБЭУ-Таракан",costRubles:125,costDollars:25,buildTime:10,tier:2,supplyCost:2},"sbeu-cicada":{id:"sbeu-cicada",label:"СБЭУ-Цикада",costRubles:100,costDollars:50,buildTime:12,tier:2,supplyCost:2},"sbeu-turtle":{id:"sbeu-turtle",label:"СБЭУ-Черепаха",costRubles:250,costDollars:100,buildTime:20,tier:3,supplyCost:3},"pmc-typok":{id:"pmc-typok",label:"Типок",costRubles:50,costDollars:0,buildTime:6,tier:1,supplyCost:1},"pmc-silach":{id:"pmc-silach",label:"Силач",costRubles:100,costDollars:0,buildTime:9,tier:2,supplyCost:2},"pmc-sniper":{id:"pmc-sniper",label:"Снайпер",costRubles:125,costDollars:50,buildTime:12,tier:2,supplyCost:2},"pmc-grenade":{id:"pmc-grenade",label:"Грената",costRubles:100,costDollars:75,buildTime:14,tier:2,supplyCost:2},"pmc-tank":{id:"pmc-tank",label:"Танк",costRubles:300,costDollars:150,buildTime:25,tier:3,supplyCost:4}};buildingCatalog={stash:{id:"stash",label:"Ячейка схрона",costRubles:100,costDollars:0,buildTime:8,radius:4,supplyBonus:8},"pmc-supply":{id:"pmc-supply",label:"Центр поставок",costRubles:150,costDollars:50,buildTime:12,radius:5,incomeKind:"dollars",incomePerSec:4,incomeRadius:8}};constructor(e,t){this.width=e,this.height=t,this.nav=new N(e,t)}blockTilesForCircle(e,t,i=!0){const s=Math.ceil(t);for(let o=-s;o<=s;o++)for(let a=-s;a<=s;a++){const l=Math.floor(e.x+a),r=Math.floor(e.y+o);a*a+o*o<=s*s&&this.nav.setBlocked(l,r,i)}}canPlaceBuilding(e,t){const i=this.buildingCatalog[e];if(!i)return!1;const s=i.radius+1;for(let o=-s;o<=s;o++)for(let a=-s;a<=s;a++){const l=Math.floor(t.x+a),r=Math.floor(t.y+o);if(a*a+o*o<=s*s&&(!this.nav.inBounds(l,r)||!this.nav.isWalkable(l,r)))return!1}for(const o of this.entities)if(Math.hypot(o.pos.x-t.x,o.pos.y-t.y)<o.radius+i.radius+1)return!1;return!0}placeBuilding(e,t,i){const s=this.buildingCatalog[t];if(!s||!this.canPlaceBuilding(t,i)||this.economy.rubles<s.costRubles||this.economy.dollars<s.costDollars)return null;this.economy.rubles-=s.costRubles,this.economy.dollars-=s.costDollars;const o={id:x++,name:s.label,type:"building",faction:e,pos:{...i},radius:s.radius,hp:800,hpMax:800,tier:1,buildingType:t,underConstruction:!0,constructRemaining:s.buildTime,supplyBonus:s.supplyBonus};return this.entities.push(o),this.blockTilesForCircle(o.pos,o.radius+1,!0),o}spawnDemo(){const e={id:x++,name:"Улей",type:"building",faction:"SBEU",pos:{x:40,y:40},radius:6,hp:1500,hpMax:1500,tier:1,trainQueue:[],garrison:0};this.entities.push(e),this.blockTilesForCircle(e.pos,e.radius+1);for(let i=0;i<6;i++){const s=this.spawnUnit("SBEU",{x:52+i*2,y:40},"sbeu-worker");s.carryRubles=0,s.carryCapacity=15,s.harvestCooldown=0}for(let i=0;i<12;i++){const s=this.spawnResource({x:70+i%6*3,y:32+Math.floor(i/6)*3},"rubles",1500);this.blockTilesForCircle(s.pos,s.radius+1)}for(let i=0;i<8;i++){const s=this.spawnResource({x:64+i%4*3,y:48+Math.floor(i/4)*3},"dollars",800);this.blockTilesForCircle(s.pos,s.radius+1)}const t={id:x++,name:"Центр поставок",type:"building",faction:"PMС",pos:{x:96,y:88},radius:5,hp:1200,hpMax:1200,tier:1,trainQueue:[],garrison:0,buildingType:"pmc-supply",underConstruction:!1};this.entities.push(t),this.blockTilesForCircle(t.pos,t.radius+1);for(let i=0;i<4;i++)this.spawnUnit("PMС",{x:90+i*2,y:96},"pmc-typok");this.objectiveText="Песочница: стройте юнитов и тестируйте управление"}spawnResource(e,t,i){const s={id:x++,name:t==="rubles"?"Рубли":"Доллары",type:"resource",faction:"NEUTRAL",pos:e,radius:3,hp:1,hpMax:1,resource:{kind:t,amount:i}};return this.entities.push(s),s}spawnUnit(e,t,i){const s=this.catalog[i],o={id:x++,name:s.label,type:"unit",faction:e,pos:{...t},radius:2.8,hp:100,hpMax:100,moveSpeed:7,supplyCost:s.supplyCost,attack:{range:8,damage:6,cooldown:1,cd:0}};return(i==="sbeu-turtle"||i==="pmc-tank")&&(o.radius=4,o.hp=260,o.hpMax=260,o.moveSpeed=4,o.attack={range:10,damage:14,cooldown:1.5,cd:0,splash:i==="pmc-tank"?2.5:void 0}),i==="pmc-sniper"&&(o.attack={range:16,damage:6,cooldown:1.2,cd:0},o.abilities={aimedShot:{cd:0,cooldown:5,bonusDamage:30}}),i==="pmc-grenade"&&(o.attack={range:10,damage:4,cooldown:2,cd:0},o.abilities={throwGrenade:{cd:0,cooldown:10,fuse:2,radius:3,damage:32,range:12}}),i==="sbeu-cicada"&&(o.attack={range:9,damage:3,cooldown:1,cd:0},o.abilities={stunGrenade:{cd:0,cooldown:12,radius:3.5,duration:2.5,range:11}}),this.entities.push(o),o}getEntityById(e){return this.entities.find(t=>t.id===e)}queryEntities(e){const t=[];for(const i of this.entities)i.type!=="resource"&&F.intersectsCircle(e,i.pos,i.radius)&&t.push(i.id);return t}pickEntity(e,t){for(let i=this.entities.length-1;i>=0;i--){const s=this.entities[i],o=e-s.pos.x,a=t-s.pos.y;if(o*o+a*a<=s.radius*s.radius)return s}return null}issueMoveCommand(e,t){const i=[],o=e.length;let a=0,l=0;for(;l<o;){const d=Math.max(6,a*8);for(let u=0;u<d&&l<o;u++){const c=u/d*Math.PI*2,h=2.5*(a+1);i.push({x:Math.cos(c)*h,y:Math.sin(c)*h}),l++}a++}const r={x:Math.floor(t.x),y:Math.floor(t.y)};e.forEach((d,u)=>{const c=this.getEntityById(d);if(!c||c.type!=="unit"||!c.moveSpeed)return;const h={x:Math.floor(c.pos.x),y:Math.floor(c.pos.y)},g={x:r.x+Math.floor(i[u].x),y:r.y+Math.floor(i[u].y)},p=U(this.nav,h,g);c.path=p,c.pathIndex=0,c.targetPos={...g},c.lastPosX=c.pos.x,c.lastPosY=c.pos.y,c.stuckTime=0})}getEconomy(){let e=0;for(const t of this.entities)t.type==="unit"&&t.faction===this.playerFaction&&(e+=t.supplyCost??0);return this.economy.supplyUsed=e,this.economy}getTrainableUnits(e,t){const i=[];for(const s of Object.values(this.catalog))s.id.startsWith("sbeu")&&e!=="SBEU"||s.id.startsWith("pmc")&&e!=="PMС"||t&&s.tier>t||i.push(s);return i}queueTrain(e,t){const i=this.getEntityById(e);if(!i||i.type!=="building")return;const s=this.catalog[t];if(!s)return;const{supplyUsed:o,supplyCap:a}=this.getEconomy();o+s.supplyCost>a||this.economy.rubles<s.costRubles||this.economy.dollars<s.costDollars||(this.economy.rubles-=s.costRubles,this.economy.dollars-=s.costDollars,i.trainQueue=i.trainQueue||[],i.trainQueue.push(t))}processTraining(e){for(const t of this.entities){if(t.type!=="building"||!t.trainQueue||t.trainQueue.length===0)continue;const i=t.trainQueue[0],s=this.catalog[i];t.garrison=(t.garrison??0)+e,t.garrison>=s.buildTime&&(t.garrison=0,t.trainQueue.shift(),this.spawnUnit(t.faction,{x:t.pos.x+8+Math.random()*4,y:t.pos.y+(Math.random()*6-3)},i))}}harvestAndIncome(e){for(const t of this.entities)if(t.type==="unit"&&t.faction==="SBEU"&&t.name.includes("Дикий")){t.harvestCooldown=Math.max(0,(t.harvestCooldown??0)-e);const i=this.entities.find(o=>o.type==="building"&&o.faction==="SBEU"&&o.name==="Улей"),s=this.entities.find(o=>o.type==="resource"&&o.resource?.kind==="rubles"&&o.resource.amount>0&&m(t.pos,o.pos)<10);if((t.carryRubles??0)>=(t.carryCapacity??15))i&&(m(t.pos,i.pos)>6?this.issueMoveCommand([t.id],i.pos):(this.economy.rubles+=t.carryRubles??0,t.carryRubles=0));else if(s&&t.harvestCooldown===0){const o=Math.min(2,s.resource.amount);s.resource.amount-=o,t.carryRubles=(t.carryRubles??0)+o,t.harvestCooldown=1}}for(const t of this.entities){if(t.type!=="building"||t.faction!=="PMС"||t.buildingType!=="pmc-supply"||t.underConstruction)continue;const i=this.buildingCatalog["pmc-supply"];if(!i.incomeKind||!i.incomePerSec||!i.incomeRadius)continue;const s=this.entities.filter(l=>l.type==="resource"&&l.resource?.kind==="dollars"&&m(l.pos,t.pos)<=i.incomeRadius);if(s.length===0)continue;let a=i.incomePerSec*e;for(const l of s){if(a<=0)break;const r=Math.min(a,l.resource.amount);l.resource.amount-=r,a-=r,this.economy.dollars+=r}}}updateEffects(e){for(const i of this.effects)i.fuse-=e;const t=this.effects.filter(i=>i.fuse<=0);this.effects=this.effects.filter(i=>i.fuse>0);for(const i of t)if(i.kind==="explosion")for(const s of this.entities)s.faction===i.faction||s.faction==="NEUTRAL"||m(s.pos,i.pos)<=i.radius&&(s.hp-=i.damage);else if(i.kind==="stun")for(const s of this.entities)s.faction!=="NEUTRAL"&&m(s.pos,i.pos)<=i.radius&&(s.stunnedUntil=Math.max(s.stunnedUntil??0,this.time+i.duration))}useAbilities(e){for(const t of this.entities){if(t.type!=="unit"||!t.abilities||(t.stunnedUntil??0)>this.time)continue;const i=this.entities.find(o=>o.faction!==t.faction&&o.faction!=="NEUTRAL"&&o.hp>0);if(!i)continue;const s=m(t.pos,i.pos);if(t.abilities.stunGrenade){const o=t.abilities.stunGrenade;o.cd=Math.max(0,o.cd-e),o.cd===0&&s<=o.range&&(this.effects.push({kind:"stun",pos:{...i.pos},fuse:.1,radius:o.radius,duration:o.duration}),o.cd=o.cooldown)}if(t.abilities.aimedShot){const o=t.abilities.aimedShot;o.cd=Math.max(0,o.cd-e),o.cd===0&&t.attack&&s<=t.attack.range&&(i.hp-=o.bonusDamage,o.cd=o.cooldown)}if(t.abilities.throwGrenade){const o=t.abilities.throwGrenade;o.cd=Math.max(0,o.cd-e),o.cd===0&&s<=o.range&&(this.effects.push({kind:"explosion",pos:{...i.pos},fuse:o.fuse,radius:o.radius,damage:o.damage,faction:t.faction}),o.cd=o.cooldown)}}}manualCastAbility(e,t,i){const s=this.getEntityById(e);if(!(!s||s.type!=="unit"||!s.abilities)){if(t==="stunGrenade"&&s.abilities.stunGrenade){const o=s.abilities.stunGrenade;o.cd===0&&(this.effects.push({kind:"stun",pos:{...i},fuse:.05,radius:o.radius,duration:o.duration}),o.cd=o.cooldown)}if(t==="aimedShot"&&s.abilities.aimedShot){const o=s.abilities.aimedShot;if(o.cd===0){const a=this.entities.find(l=>l.faction!==s.faction&&l.faction!=="NEUTRAL"&&m(l.pos,i)<4);a&&(a.hp-=o.bonusDamage),o.cd=o.cooldown}}if(t==="throwGrenade"&&s.abilities.throwGrenade){const o=s.abilities.throwGrenade;o.cd===0&&(this.effects.push({kind:"explosion",pos:{...i},fuse:o.fuse,radius:o.radius,damage:o.damage,faction:s.faction}),o.cd=o.cooldown)}}}update(e){this.time+=e;for(const t of this.entities){if(t.type!=="unit"||!t.moveSpeed)continue;let i=0,s=0,o=0;for(const a of this.entities){if(a===t||a.type!=="unit"||a.faction!==t.faction)continue;const l=t.pos.x-a.pos.x,r=t.pos.y-a.pos.y,d=l*l+r*r,u=t.radius+a.radius+1;if(d<u*u&&d>1e-4){const c=Math.sqrt(d);i+=l/c,s+=r/c,o++}}o&&(t.pos.x+=i/o*2*e,t.pos.y+=s/o*2*e)}for(const t of this.entities)if(!(t.type!=="unit"||!t.moveSpeed)&&!((t.stunnedUntil??0)>this.time)&&t.path&&t.pathIndex<t.path.length){const i=t.path[t.pathIndex],s={x:i.x,y:i.y},o=s.x-t.pos.x,a=s.y-t.pos.y,l=Math.hypot(o,a);if(l<.2)t.pathIndex++;else{const c=o/(l||1),h=a/(l||1);t.pos.x+=c*t.moveSpeed*e,t.pos.y+=h*t.moveSpeed*e}const r=t.lastPosX??t.pos.x,d=t.lastPosY??t.pos.y,u=Math.hypot(t.pos.x-r,t.pos.y-d);if(t.stuckTime=(t.stuckTime??0)+e,u>.3)t.lastPosX=t.pos.x,t.lastPosY=t.pos.y,t.stuckTime=0;else if(t.stuckTime>1&&t.targetPos){const c={x:Math.floor(t.pos.x),y:Math.floor(t.pos.y)},h={x:Math.floor(t.targetPos.x),y:Math.floor(t.targetPos.y)};t.path=U(this.nav,c,h),t.pathIndex=0,t.stuckTime=0}}this.useAbilities(e);for(const t of this.entities){if(!t.attack)continue;if((t.stunnedUntil??0)>this.time){t.attack.cd=Math.max(0,t.attack.cd-e);continue}t.attack.cd=Math.max(0,t.attack.cd-e);const i=this.entities.find(s=>s.faction!==t.faction&&s.faction!=="NEUTRAL"&&s.hp>0&&m(t.pos,s.pos)<=t.attack.range);if(i&&t.attack.cd<=0){if(i.hp-=t.attack.damage,t.attack.splash)for(const s of this.entities)s!==i&&(s.faction===t.faction||s.faction==="NEUTRAL"||m(s.pos,i.pos)<=t.attack.splash&&(s.hp-=Math.max(1,Math.floor(t.attack.damage*.4))));t.attack.cd=t.attack.cooldown}}this.updateEffects(e);for(const t of this.entities)t.type==="building"&&t.underConstruction&&(t.constructRemaining=Math.max(0,(t.constructRemaining??0)-e),t.constructRemaining===0&&(t.underConstruction=!1,t.supplyBonus&&(this.economy.supplyCap+=t.supplyBonus)));this.entities=this.entities.filter(t=>t.hp>0||t.type==="resource"),this.processTraining(e),this.harvestAndIncome(e),this.onUpdateExtra&&this.onUpdateExtra(this,e)}render(e){e.save(),e.strokeStyle="#0f172a",e.lineWidth=1;for(let t=0;t<=this.height;t+=8)e.beginPath(),e.moveTo(0,t),e.lineTo(this.width,t),e.stroke();for(let t=0;t<=this.width;t+=8)e.beginPath(),e.moveTo(t,0),e.lineTo(t,this.height),e.stroke();for(const t of this.effects)t.kind==="explosion"?(e.strokeStyle="rgba(239,68,68,0.6)",e.beginPath(),e.arc(t.pos.x,t.pos.y,t.radius,0,Math.PI*2),e.stroke()):t.kind==="stun"&&(e.strokeStyle="rgba(96,165,250,0.6)",e.beginPath(),e.arc(t.pos.x,t.pos.y,t.radius,0,Math.PI*2),e.stroke());for(const t of this.entities)t.type==="resource"&&(e.fillStyle=t.resource.kind==="rubles"?"#3b82f6":"#22c55e",e.beginPath(),e.arc(t.pos.x,t.pos.y,2.5,0,Math.PI*2),e.fill());for(const t of this.entities)if(t.type==="building"){if(e.fillStyle=t.faction==="SBEU"?"#9333ea":"#ef4444",e.fillRect(t.pos.x-t.radius,t.pos.y-t.radius,t.radius*2,t.radius*2),t.underConstruction&&(e.fillStyle="rgba(248,113,113,0.3)",e.fillRect(t.pos.x-t.radius,t.pos.y-t.radius,t.radius*2,t.radius*2)),t.faction==="PMС"&&t.buildingType==="pmc-supply"){const i=this.buildingCatalog["pmc-supply"];i.incomeRadius&&(e.strokeStyle="rgba(34,197,94,0.35)",e.beginPath(),e.arc(t.pos.x,t.pos.y,i.incomeRadius,0,Math.PI*2),e.stroke())}A(e,t)}for(const t of this.entities)if(t.type==="unit"){const i=(t.stunnedUntil??0)>this.time;e.fillStyle=t.faction==="SBEU"?"#a78bfa":"#f87171",e.globalAlpha=i?.6:1,e.beginPath(),e.arc(t.pos.x,t.pos.y,t.radius,0,Math.PI*2),e.fill(),e.globalAlpha=1,A(e,t)}e.restore()}}function A(n,e){const s=e.pos.x-6,o=e.pos.y-(e.type==="building"?e.radius+4:e.radius+6);n.fillStyle="#111827",n.fillRect(s,o,12,2);const a=Math.max(0,Math.min(1,e.hp/e.hpMax));n.fillStyle=a>.6?"#22c55e":a>.3?"#eab308":"#ef4444",n.fillRect(s,o,12*a,2)}function m(n,e){return Math.hypot(n.x-e.x,n.y-e.y)}class O{canvas;ctx;world;camera={x:0,y:0,zoom:1};mouse={x:0,y:0,worldX:0,worldY:0,down:!1};selectionStart=null;selectedIds=new Set;pendingAbility=null;buildPlacer=null;groups={};constructor(e,t){this.canvas=e,this.ctx=t,this.world=new W(128,128),this.world.spawnDemo(),this.bindInput()}loadWorld(e){this.world=e,this.selectedIds.clear(),this.camera={x:0,y:0,zoom:1},this.pendingAbility=null,this.buildPlacer=null}bindInput(){this.canvas.addEventListener("mousemove",e=>{const t=this.canvas.getBoundingClientRect();this.mouse.x=e.clientX-t.left,this.mouse.y=e.clientY-t.top,this.mouse.worldX=this.mouse.x/this.camera.zoom+this.camera.x,this.mouse.worldY=this.mouse.y/this.camera.zoom+this.camera.y}),this.canvas.addEventListener("mousedown",e=>{e.button===0&&(this.mouse.down=!0,this.selectionStart={x:this.mouse.worldX,y:this.mouse.worldY})}),window.addEventListener("mouseup",e=>{if(e.button===0){if(this.mouse.down=!1,this.pendingAbility){this.world.manualCastAbility(this.pendingAbility.casterId,this.pendingAbility.kind,{x:this.mouse.worldX,y:this.mouse.worldY}),this.pendingAbility=null,this.selectionStart=null;return}if(this.buildPlacer){this.world.placeBuilding(this.world.playerFaction,this.buildPlacer.typeId,{x:this.mouse.worldX,y:this.mouse.worldY}),this.buildPlacer=null,this.selectionStart=null;return}this.commitSelection(),this.selectionStart=null}}),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),this.canvas.addEventListener("mouseup",e=>{if(e.button===2){if(this.pendingAbility||this.buildPlacer){this.pendingAbility=null,this.buildPlacer=null;return}const t={x:this.mouse.worldX,y:this.mouse.worldY};this.world.issueMoveCommand([...this.selectedIds],t)}}),window.addEventListener("keydown",e=>{(e.key==="ArrowUp"||e.key==="w")&&(this.camera.y-=32),(e.key==="ArrowDown"||e.key==="s")&&(this.camera.y+=32),(e.key==="ArrowLeft"||e.key==="a")&&(this.camera.x-=32),(e.key==="ArrowRight"||e.key==="d")&&(this.camera.x+=32);const i=parseInt(e.key,10);if(!isNaN(i)&&i>=1&&i<=9)if(e.ctrlKey||e.metaKey)this.groups[i]=[...this.selectedIds];else{const s=this.groups[i]||[];this.selectedIds=new Set(s)}if(e.key.toLowerCase()==="q"||e.key.toLowerCase()==="w"||e.key.toLowerCase()==="e"){const s=[...this.selectedIds].map(o=>this.world.getEntityById(o)).find(o=>o?.type==="unit"&&o.abilities);s&&s?.abilities&&(e.key.toLowerCase()==="q"&&s.abilities.stunGrenade&&(this.pendingAbility={casterId:s.id,kind:"stunGrenade"}),e.key.toLowerCase()==="w"&&s.abilities.aimedShot&&(this.pendingAbility={casterId:s.id,kind:"aimedShot"}),e.key.toLowerCase()==="e"&&s.abilities.throwGrenade&&(this.pendingAbility={casterId:s.id,kind:"throwGrenade"}))}e.key.toLowerCase()==="b"&&(this.buildPlacer={typeId:"stash"}),e.key.toLowerCase()==="c"&&(this.buildPlacer={typeId:"pmc-supply"})}),this.canvas.addEventListener("wheel",e=>{const t=e.deltaY>0?.9:1.1,i=this.screenToWorld(this.mouse.x,this.mouse.y);this.camera.zoom=Math.max(.5,Math.min(2,this.camera.zoom*t));const s=this.screenToWorld(this.mouse.x,this.mouse.y);this.camera.x+=i.x-s.x,this.camera.y+=i.y-s.y},{passive:!0})}screenToWorld(e,t){return{x:e/this.camera.zoom+this.camera.x,y:t/this.camera.zoom+this.camera.y}}commitSelection(){if(!this.selectionStart){const i=this.world.pickEntity(this.mouse.worldX,this.mouse.worldY);this.selectedIds.clear(),i&&this.selectedIds.add(i.id);return}const e=F.fromPoints(this.selectionStart,{x:this.mouse.worldX,y:this.mouse.worldY}),t=this.world.queryEntities(e);this.selectedIds=new Set(t)}update(e){this.world.update(e)}render(){const{ctx:e}=this;if(e.save(),e.clearRect(0,0,this.canvas.width,this.canvas.height),e.scale(this.camera.zoom,this.camera.zoom),e.translate(-this.camera.x,-this.camera.y),this.world.render(e),this.mouse.down&&this.selectionStart&&!this.pendingAbility&&!this.buildPlacer){const t=Math.min(this.selectionStart.x,this.mouse.worldX),i=Math.min(this.selectionStart.y,this.mouse.worldY),s=Math.abs(this.selectionStart.x-this.mouse.worldX),o=Math.abs(this.selectionStart.y-this.mouse.worldY);e.strokeStyle="#60a5fa",e.lineWidth=1,e.strokeRect(t,i,s,o)}if(this.pendingAbility&&(e.strokeStyle="#f59e0b",e.beginPath(),e.arc(this.mouse.worldX,this.mouse.worldY,3,0,Math.PI*2),e.stroke()),this.buildPlacer){const t=this.buildPlacer.typeId,i=this.world.canPlaceBuilding(t,{x:this.mouse.worldX,y:this.mouse.worldY});e.strokeStyle=i?"#22c55e":"#ef4444",e.lineWidth=2;const s=this.world.buildingCatalog[t].radius;e.strokeRect(this.mouse.worldX-s,this.mouse.worldY-s,s*2,s*2)}for(const t of this.selectedIds){const i=this.world.getEntityById(t);i&&(e.strokeStyle="#34d399",e.lineWidth=2,e.beginPath(),e.arc(i.pos.x,i.pos.y,i.radius+2,0,Math.PI*2),e.stroke())}e.restore()}getUIState(){const e=this.world.getEconomy(),t=[...this.selectedIds].map(o=>this.world.getEntityById(o)).filter(Boolean),i=t.length===1?`${t[0].name} (HP ${Math.ceil(t[0].hp)})`:t.length>1?`${t.length} юнитов`:"—",s=[];if(t.length===1&&t[0].type==="building"){const o=t[0];for(const a of this.world.getTrainableUnits(o.faction,o.tier))s.push({id:`train:${a.id}`,label:`Нанять ${a.label}`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>this.world.queueTrain(o.id,a.id)});if(o.faction===this.world.playerFaction){const a=this.world.buildingCatalog.stash;s.push({id:"build:stash",label:`Построить ${a.label} (B)`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>{this.buildPlacer={typeId:"stash"}}});const l=this.world.buildingCatalog["pmc-supply"];s.push({id:"build:pmc",label:`Построить ${l.label} (C)`,costRubles:l.costRubles,costDollars:l.costDollars,onClick:()=>{this.buildPlacer={typeId:"pmc-supply"}}})}}if(t.length===1&&t[0].type==="unit"){const o=t[0];if(o.faction===this.world.playerFaction){const a=this.world.buildingCatalog.stash;s.push({id:"build:stash",label:`Построить ${a.label} (B)`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>{this.buildPlacer={typeId:"stash"}}});const l=this.world.buildingCatalog["pmc-supply"];s.push({id:"build:pmc",label:`Построить ${l.label} (C)`,costRubles:l.costRubles,costDollars:l.costDollars,onClick:()=>{this.buildPlacer={typeId:"pmc-supply"}}})}o.abilities&&(o.abilities.stunGrenade&&s.push({id:`ab:stun:${o.id}`,label:"Оглушающая граната (Q)",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"stunGrenade"}}}),o.abilities.aimedShot&&s.push({id:`ab:aim:${o.id}`,label:"Прицельный выстрел (W)",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"aimedShot"}}}),o.abilities.throwGrenade&&s.push({id:`ab:nade:${o.id}`,label:"Кинуть гранату (E)",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"throwGrenade"}}}))}return{rubles:e.rubles,dollars:e.dollars,selectedCount:t.length,inspector:i,objective:this.world.objectiveText,supply:`${this.world.economy.supplyUsed}/${this.world.economy.supplyCap}`,actions:s}}}function b(n,e,t,i){for(const s of i)for(let o=0;o<s.count;o++)n.spawnUnit(e,{x:t.x+(Math.random()*6-3),y:t.y+(Math.random()*6-3)},s.unitId)}function P(n,e){n.objectiveText="Уничтожьте все силы противника",n.winCondition=t=>t.entities.every(i=>i.faction===e||i.faction==="NEUTRAL")}function v(n,e){const t=e*60;n.objectiveText=`Продержитесь ${e} минут`,n.winCondition=i=>i.time>=t}function H(n,e,t){n.objectiveText=`Накопите ресурсы: ₽${e} и $${t}`,n.winCondition=i=>i.getEconomy().rubles>=e&&i.getEconomy().dollars>=t}const K={SBEU:{id:"SBEU",name:"Кампания СБЭУ",missions:[{id:"sbeu-1",name:"Инструктаж зверинца",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),n.objectiveText="Выделяйте юнитов и отдавайте приказы. Постройте пару бойцов",n.onUpdateExtra=(e,t)=>{},n.winCondition=e=>e.entities.filter(t=>t.faction==="SBEU"&&t.type==="unit").length>=10}},{id:"sbeu-2",name:"Отбить ресурсные точки",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo();for(const e of n.entities.filter(t=>t.type==="resource"))b(n,"PMС",{x:e.pos.x+6,y:e.pos.y+6},[{unitId:"pmc-typok",count:3}]);n.objectiveText="Очистите окрестности ресурсов",n.winCondition=e=>e.entities.every(t=>!(t.faction==="PMС"&&t.type==="unit"))}},{id:"sbeu-3",name:"Штурм укрепточки",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),b(n,"PMС",{x:92,y:86},[{unitId:"pmc-silach",count:3},{unitId:"pmc-sniper",count:2}]),P(n,"SBEU")}},{id:"sbeu-4",name:"Накопить на штурм",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),H(n,1e3,300);let e=0;n.onUpdateExtra=(t,i)=>{e+=i,e>20&&(e=0,b(t,"PMС",{x:88,y:92},[{unitId:"pmc-typok",count:4},{unitId:"pmc-grenade",count:1}]))}}},{id:"sbeu-5",name:"Штурм водоочистной",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),b(n,"PMС",{x:94,y:84},[{unitId:"pmc-silach",count:4},{unitId:"pmc-sniper",count:2},{unitId:"pmc-tank",count:1}]),P(n,"SBEU")}}]},PMC:{id:"PMC",name:"Кампания ЧВК",missions:[{id:"pmc-1",name:"Прибытие Зубешко",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),n.objectiveText="Инструктаж по механикам ЧВК",n.winCondition=e=>e.entities.filter(t=>t.faction==="PMС"&&t.type==="unit").length>=8}},{id:"pmc-2",name:"Оборона укрепления A",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),v(n,3);let e=0;n.onUpdateExtra=(t,i)=>{e+=i,e>15&&(e=0,b(t,"SBEU",{x:60,y:30},[{unitId:"sbeu-worm",count:6},{unitId:"sbeu-caterpillar",count:2}]))}}},{id:"pmc-3",name:"Оборона укрепления B",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),v(n,4);let e=0;n.onUpdateExtra=(t,i)=>{e+=i,e>18&&(e=0,b(t,"SBEU",{x:66,y:52},[{unitId:"sbeu-cockroach",count:3},{unitId:"sbeu-cicada",count:2}]))}}},{id:"pmc-4",name:"Предательство Пуссильченко",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),v(n,5);let e=0;n.onUpdateExtra=(t,i)=>{e+=i,e>20&&(e=0,b(t,"SBEU",{x:70,y:46},[{unitId:"sbeu-worm",count:6},{unitId:"sbeu-cockroach",count:4},{unitId:"sbeu-turtle",count:1}]))}}},{id:"pmc-5",name:"Контрнаступление",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),P(n,"PMС")}}]}};function _(n,e){const i=K[n].missions[e],s=new W(128,128);return s.playerFaction=i.faction,i.setup(s),s}const w=document.getElementById("game"),G=w.getContext("2d");function X(){const n=Math.max(1,Math.min(2,window.devicePixelRatio||1));w.width=Math.floor(window.innerWidth*n),w.height=Math.floor(window.innerHeight*n),w.style.width=`${window.innerWidth}px`,w.style.height=`${window.innerHeight}px`,G.setTransform(n,0,0,n,0,0)}X();window.addEventListener("resize",X);const E=new O(w,G);let C="SBEU",M=0;function I(){E.loadWorld(_(C,M))}I();let L=performance.now();function Y(n){const e=Math.min(.05,(n-L)/1e3);L=n,E.update(e),E.render(),requestAnimationFrame(Y)}requestAnimationFrame(Y);const J=document.getElementById("rubles"),V=document.getElementById("dollars"),Z=document.getElementById("supply"),tt=document.getElementById("selected"),et=document.getElementById("inspector"),R=document.getElementById("actions");function st(){const n=E.getUIState();J.textContent=String(n.rubles),V.textContent=String(n.dollars),Z.textContent=n.supply??"0/0",tt.textContent=String(n.selectedCount),et.textContent=n.inspector+(n.objective?` | Цель: ${n.objective}`:""),R.innerHTML="",$(`Кампания: ${C}`,()=>{C=C==="SBEU"?"PMC":"SBEU",M=0,I()}),$(`Миссия ${M+1}/5`,()=>{M=(M+1)%5,I()});for(const e of n.actions){const t=document.createElement("div");t.className="btn",t.textContent=`${e.label} (${e.costRubles}₽/${e.costDollars}$)`,t.onclick=()=>e.onClick(),R.appendChild(t)}}function $(n,e){const t=document.createElement("div");t.className="btn",t.textContent=n,t.onclick=e,R.appendChild(t)}setInterval(st,120);
