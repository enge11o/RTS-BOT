(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const $={fromPoints(n,e){const t=Math.min(n.x,e.x),s=Math.min(n.y,e.y);return{x:t,y:s,w:Math.abs(n.x-e.x),h:Math.abs(n.y-e.y)}},contains(n,e){return e.x>=n.x&&e.y>=n.y&&e.x<=n.x+n.w&&e.y<=n.y+n.h},intersectsCircle(n,e,t){const s=Math.max(n.x,Math.min(e.x,n.x+n.w)),i=Math.max(n.y,Math.min(e.y,n.y+n.h)),o=e.x-s,a=e.y-i;return o*o+a*a<=t*t}};class X{width;height;nodes;constructor(e,t){this.width=e,this.height=t,this.nodes=new Array(e*t).fill(0).map((s,i)=>({x:i%e,y:Math.floor(i/e),walkable:!0}))}idx(e,t){return t*this.width+e}inBounds(e,t){return e>=0&&t>=0&&e<this.width&&t<this.height}setBlocked(e,t,s){this.inBounds(e,t)&&(this.nodes[this.idx(e,t)].walkable=!s)}isWalkable(e,t){return this.inBounds(e,t)&&this.nodes[this.idx(e,t)].walkable}}function Y(n,e,t){const s=Math.round(e.x),i=Math.round(e.y),o=Math.round(t.x),a=Math.round(t.y);if(!n.inBounds(s,i)||!n.inBounds(o,a))return[];const r=[],l=new Map,u=new Map,d=new Map,c=n.idx(s,i);r.push(c),u.set(c,0),d.set(c,T(s,i,o,a));const m=new Set;for(;r.length;){let g=0;for(let f=1;f<r.length;f++)(d.get(r[f])??1/0)<(d.get(r[g])??1/0)&&(g=f);const p=r.splice(g,1)[0];if(p===n.idx(o,a))return j(n,l,p);m.add(p);const I=p%n.width,R=Math.floor(p/n.width);for(const[f,k]of z(n,I,R)){const y=n.idx(f,k);if(m.has(y)||!n.isWalkable(f,k))continue;const S=(u.get(p)??1/0)+Q(I,R,f,k);if(!r.includes(y))r.push(y);else if(S>=(u.get(y)??1/0))continue;l.set(y,p),u.set(y,S),d.set(y,S+T(f,k,o,a))}}return[]}function j(n,e,t){const s=[];for(;e.has(t);){const i=t%n.width,o=Math.floor(t/n.width);s.push({x:i,y:o}),t=e.get(t)}return s.reverse(),s.length>1&&q(s),s}function z(n,e,t){const s=[];for(let i=-1;i<=1;i++)for(let o=-1;o<=1;o++){if(o===0&&i===0)continue;const a=e+o,r=t+i;n.inBounds(a,r)&&n.isWalkable(a,r)&&(o!==0&&i!==0&&(!n.isWalkable(e+o,t)||!n.isWalkable(e,t+i))||s.push([a,r]))}return s}function T(n,e,t,s){const i=Math.abs(n-t),o=Math.abs(e-s);return i+o+(Math.SQRT2-2)*Math.min(i,o)}function Q(n,e,t,s){return Math.hypot(t-n,s-e)}function q(n){for(let e=n.length-3;e>=0;e--){const t=n[e],s=n[e+1],i=n[e+2],o=s.x-t.x,a=s.y-t.y,r=i.x-s.x,l=i.y-s.y;o===r&&a===l&&n.splice(e+1,1)}}let x=1;class W{width;height;tileSize=16;nav;entities=[];effects=[];economy={rubles:500,dollars:200,supplyCap:10,supplyUsed:0};time=0;playerFaction="SBEU";objectiveText="Песочница";onUpdateExtra;winCondition;loseCondition;catalog={"sbeu-worker":{id:"sbeu-worker",label:"Дикий (рабочий)",costRubles:50,costDollars:0,buildTime:4,tier:1,supplyCost:1},"sbeu-worm":{id:"sbeu-worm",label:"СБЭУ-Червь",costRubles:50,costDollars:0,buildTime:6,tier:1,supplyCost:1},"sbeu-caterpillar":{id:"sbeu-caterpillar",label:"СБЭУ-Гусеница",costRubles:75,costDollars:0,buildTime:7,tier:1,supplyCost:1},"sbeu-cockroach":{id:"sbeu-cockroach",label:"СБЭУ-Таракан",costRubles:125,costDollars:25,buildTime:10,tier:2,supplyCost:2},"sbeu-cicada":{id:"sbeu-cicada",label:"СБЭУ-Цикада",costRubles:100,costDollars:50,buildTime:12,tier:2,supplyCost:2},"sbeu-turtle":{id:"sbeu-turtle",label:"СБЭУ-Черепаха",costRubles:250,costDollars:100,buildTime:20,tier:3,supplyCost:3},"pmc-typok":{id:"pmc-typok",label:"Типок",costRubles:50,costDollars:0,buildTime:6,tier:1,supplyCost:1},"pmc-silach":{id:"pmc-silach",label:"Силач",costRubles:100,costDollars:0,buildTime:9,tier:2,supplyCost:2},"pmc-sniper":{id:"pmc-sniper",label:"Снайпер",costRubles:125,costDollars:50,buildTime:12,tier:2,supplyCost:2},"pmc-grenade":{id:"pmc-grenade",label:"Грената",costRubles:100,costDollars:75,buildTime:14,tier:2,supplyCost:2},"pmc-tank":{id:"pmc-tank",label:"Танк",costRubles:300,costDollars:150,buildTime:25,tier:3,supplyCost:4}};buildingCatalog={stash:{id:"stash",label:"Ячейка схрона",costRubles:100,costDollars:0,buildTime:8,radius:4,supplyBonus:8}};constructor(e,t){this.width=e,this.height=t,this.nav=new X(e,t)}blockTilesForCircle(e,t,s=!0){const i=Math.ceil(t);for(let o=-i;o<=i;o++)for(let a=-i;a<=i;a++){const r=Math.floor(e.x+a),l=Math.floor(e.y+o);a*a+o*o<=i*i&&this.nav.setBlocked(r,l,s)}}canPlaceBuilding(e,t){const s=this.buildingCatalog[e];if(!s)return!1;const i=s.radius+1;for(let o=-i;o<=i;o++)for(let a=-i;a<=i;a++){const r=Math.floor(t.x+a),l=Math.floor(t.y+o);if(a*a+o*o<=i*i&&(!this.nav.inBounds(r,l)||!this.nav.isWalkable(r,l)))return!1}for(const o of this.entities)if(Math.hypot(o.pos.x-t.x,o.pos.y-t.y)<o.radius+s.radius+1)return!1;return!0}placeBuilding(e,t,s){const i=this.buildingCatalog[t];if(!i||!this.canPlaceBuilding(t,s)||this.economy.rubles<i.costRubles||this.economy.dollars<i.costDollars)return null;this.economy.rubles-=i.costRubles,this.economy.dollars-=i.costDollars;const o={id:x++,name:i.label,type:"building",faction:e,pos:{...s},radius:i.radius,hp:800,hpMax:800,tier:1,buildingType:t,underConstruction:!0,constructRemaining:i.buildTime,supplyBonus:i.supplyBonus};return this.entities.push(o),this.blockTilesForCircle(o.pos,o.radius+1,!0),o}spawnDemo(){const e={id:x++,name:"Улей",type:"building",faction:"SBEU",pos:{x:40,y:40},radius:6,hp:1500,hpMax:1500,tier:1,trainQueue:[],garrison:0};this.entities.push(e),this.blockTilesForCircle(e.pos,e.radius+1);for(let s=0;s<6;s++){const i=this.spawnUnit("SBEU",{x:52+s*2,y:40},"sbeu-worker");i.carryRubles=0,i.carryCapacity=15,i.harvestCooldown=0}for(let s=0;s<12;s++){const i=this.spawnResource({x:70+s%6*3,y:32+Math.floor(s/6)*3},"rubles",1500);this.blockTilesForCircle(i.pos,i.radius+1)}for(let s=0;s<8;s++){const i=this.spawnResource({x:64+s%4*3,y:48+Math.floor(s/4)*3},"dollars",800);this.blockTilesForCircle(i.pos,i.radius+1)}const t={id:x++,name:"Центр поставок",type:"building",faction:"PMС",pos:{x:96,y:88},radius:6,hp:1400,hpMax:1400,tier:1,trainQueue:[],garrison:0};this.entities.push(t),this.blockTilesForCircle(t.pos,t.radius+1);for(let s=0;s<4;s++)this.spawnUnit("PMС",{x:90+s*2,y:96},"pmc-typok");this.objectiveText="Песочница: стройте юнитов и тестируйте управление"}spawnResource(e,t,s){const i={id:x++,name:t==="rubles"?"Рубли":"Доллары",type:"resource",faction:"NEUTRAL",pos:e,radius:3,hp:1,hpMax:1,resource:{kind:t,amount:s}};return this.entities.push(i),i}spawnUnit(e,t,s){const i=this.catalog[s],o={id:x++,name:i.label,type:"unit",faction:e,pos:{...t},radius:2.8,hp:100,hpMax:100,moveSpeed:7,supplyCost:i.supplyCost,attack:{range:8,damage:6,cooldown:1,cd:0}};return(s==="sbeu-turtle"||s==="pmc-tank")&&(o.radius=4,o.hp=260,o.hpMax=260,o.moveSpeed=4,o.attack={range:10,damage:14,cooldown:1.5,cd:0,splash:s==="pmc-tank"?2.5:void 0}),s==="pmc-sniper"&&(o.attack={range:16,damage:6,cooldown:1.2,cd:0},o.abilities={aimedShot:{cd:0,cooldown:5,bonusDamage:30}}),s==="pmc-grenade"&&(o.attack={range:10,damage:4,cooldown:2,cd:0},o.abilities={throwGrenade:{cd:0,cooldown:10,fuse:2,radius:3,damage:32,range:12}}),s==="sbeu-cicada"&&(o.attack={range:9,damage:3,cooldown:1,cd:0},o.abilities={stunGrenade:{cd:0,cooldown:12,radius:3.5,duration:2.5,range:11}}),this.entities.push(o),o}getEntityById(e){return this.entities.find(t=>t.id===e)}queryEntities(e){const t=[];for(const s of this.entities)s.type!=="resource"&&$.intersectsCircle(e,s.pos,s.radius)&&t.push(s.id);return t}pickEntity(e,t){for(let s=this.entities.length-1;s>=0;s--){const i=this.entities[s],o=e-i.pos.x,a=t-i.pos.y;if(o*o+a*a<=i.radius*i.radius)return i}return null}issueMoveCommand(e,t){const s=[],o=e.length;let a=0,r=0;for(;r<o;){const u=Math.max(6,a*8);for(let d=0;d<u&&r<o;d++){const c=d/u*Math.PI*2,m=2.5*(a+1);s.push({x:Math.cos(c)*m,y:Math.sin(c)*m}),r++}a++}const l={x:Math.floor(t.x),y:Math.floor(t.y)};e.forEach((u,d)=>{const c=this.getEntityById(u);if(!c||c.type!=="unit"||!c.moveSpeed)return;const m={x:Math.floor(c.pos.x),y:Math.floor(c.pos.y)},g={x:l.x+Math.floor(s[d].x),y:l.y+Math.floor(s[d].y)},p=Y(this.nav,m,g);c.path=p,c.pathIndex=0,c.targetPos={...g}})}getEconomy(){let e=0;for(const t of this.entities)t.type==="unit"&&t.faction===this.playerFaction&&(e+=t.supplyCost??0);return this.economy.supplyUsed=e,this.economy}getTrainableUnits(e,t){const s=[];for(const i of Object.values(this.catalog))i.id.startsWith("sbeu")&&e!=="SBEU"||i.id.startsWith("pmc")&&e!=="PMС"||t&&i.tier>t||s.push(i);return s}queueTrain(e,t){const s=this.getEntityById(e);if(!s||s.type!=="building")return;const i=this.catalog[t];if(!i)return;const{supplyUsed:o,supplyCap:a}=this.getEconomy();o+i.supplyCost>a||this.economy.rubles<i.costRubles||this.economy.dollars<i.costDollars||(this.economy.rubles-=i.costRubles,this.economy.dollars-=i.costDollars,s.trainQueue=s.trainQueue||[],s.trainQueue.push(t))}processTraining(e){for(const t of this.entities){if(t.type!=="building"||!t.trainQueue||t.trainQueue.length===0)continue;const s=t.trainQueue[0],i=this.catalog[s];t.garrison=(t.garrison??0)+e,t.garrison>=i.buildTime&&(t.garrison=0,t.trainQueue.shift(),this.spawnUnit(t.faction,{x:t.pos.x+8+Math.random()*4,y:t.pos.y+(Math.random()*6-3)},s))}}harvestAndIncome(e){for(const t of this.entities){if(t.type==="unit"&&t.faction==="SBEU"&&t.name.includes("Дикий")){t.harvestCooldown=Math.max(0,(t.harvestCooldown??0)-e);const s=this.entities.find(o=>o.type==="building"&&o.faction==="SBEU"&&o.name==="Улей"),i=this.entities.find(o=>o.type==="resource"&&o.resource?.kind==="rubles"&&o.resource.amount>0&&h(t.pos,o.pos)<10);if((t.carryRubles??0)>=(t.carryCapacity??15))s&&(h(t.pos,s.pos)>6?this.issueMoveCommand([t.id],s.pos):(this.economy.rubles+=t.carryRubles??0,t.carryRubles=0));else if(i){if(t.harvestCooldown===0){const o=Math.min(2,i.resource.amount);i.resource.amount-=o,t.carryRubles=(t.carryRubles??0)+o,t.harvestCooldown=1}}else{const o=this.entities.filter(a=>a.type==="resource"&&a.resource?.kind==="rubles"&&a.resource.amount>0).sort((a,r)=>h(t.pos,a.pos)-h(t.pos,r.pos))[0];o&&this.issueMoveCommand([t.id],o.pos)}}t.type==="building"&&t.faction==="PMС"&&t.name.includes("Центр поставок")&&(this.economy.dollars+=3*e)}}updateEffects(e){for(const s of this.effects)s.fuse-=e;const t=this.effects.filter(s=>s.fuse<=0);this.effects=this.effects.filter(s=>s.fuse>0);for(const s of t)if(s.kind==="explosion")for(const i of this.entities)i.faction===s.faction||i.faction==="NEUTRAL"||h(i.pos,s.pos)<=s.radius&&(i.hp-=s.damage);else if(s.kind==="stun")for(const i of this.entities)i.faction!=="NEUTRAL"&&h(i.pos,s.pos)<=s.radius&&(i.stunnedUntil=Math.max(i.stunnedUntil??0,this.time+s.duration))}useAbilities(e){for(const t of this.entities){if(t.type!=="unit"||!t.abilities||(t.stunnedUntil??0)>this.time)continue;const s=this.entities.find(o=>o.faction!==t.faction&&o.faction!=="NEUTRAL"&&o.hp>0);if(!s)continue;const i=h(t.pos,s.pos);if(t.abilities.stunGrenade){const o=t.abilities.stunGrenade;o.cd=Math.max(0,o.cd-e),o.cd===0&&i<=o.range&&(this.effects.push({kind:"stun",pos:{...s.pos},fuse:.1,radius:o.radius,duration:o.duration}),o.cd=o.cooldown)}if(t.abilities.aimedShot){const o=t.abilities.aimedShot;o.cd=Math.max(0,o.cd-e),o.cd===0&&t.attack&&i<=t.attack.range&&(s.hp-=o.bonusDamage,o.cd=o.cooldown)}if(t.abilities.throwGrenade){const o=t.abilities.throwGrenade;o.cd=Math.max(0,o.cd-e),o.cd===0&&i<=o.range&&(this.effects.push({kind:"explosion",pos:{...s.pos},fuse:o.fuse,radius:o.radius,damage:o.damage,faction:t.faction}),o.cd=o.cooldown)}}}manualCastAbility(e,t,s){const i=this.getEntityById(e);if(!(!i||i.type!=="unit"||!i.abilities)){if(t==="stunGrenade"&&i.abilities.stunGrenade){const o=i.abilities.stunGrenade;o.cd===0&&(this.effects.push({kind:"stun",pos:{...s},fuse:.05,radius:o.radius,duration:o.duration}),o.cd=o.cooldown)}if(t==="aimedShot"&&i.abilities.aimedShot){const o=i.abilities.aimedShot;if(o.cd===0){const a=this.entities.find(r=>r.faction!==i.faction&&r.faction!=="NEUTRAL"&&h(r.pos,s)<4);a&&(a.hp-=o.bonusDamage),o.cd=o.cooldown}}if(t==="throwGrenade"&&i.abilities.throwGrenade){const o=i.abilities.throwGrenade;o.cd===0&&(this.effects.push({kind:"explosion",pos:{...s},fuse:o.fuse,radius:o.radius,damage:o.damage,faction:i.faction}),o.cd=o.cooldown)}}}update(e){this.time+=e;for(const t of this.entities){if(t.type!=="unit"||!t.moveSpeed)continue;let s=0,i=0,o=0;for(const a of this.entities){if(a===t||a.type!=="unit"||a.faction!==t.faction)continue;const r=t.pos.x-a.pos.x,l=t.pos.y-a.pos.y,u=r*r+l*l,d=t.radius+a.radius+1;if(u<d*d&&u>1e-4){const c=Math.sqrt(u);s+=r/c,i+=l/c,o++}}o&&(t.pos.x+=s/o*2*e,t.pos.y+=i/o*2*e)}for(const t of this.entities)if(!(t.type!=="unit"||!t.moveSpeed)&&!((t.stunnedUntil??0)>this.time)&&t.path&&t.pathIndex<t.path.length){const s=t.path[t.pathIndex],i={x:s.x,y:s.y},o=i.x-t.pos.x,a=i.y-t.pos.y,r=Math.hypot(o,a);if(r<.2)t.pathIndex++;else{const l=o/(r||1),u=a/(r||1);t.pos.x+=l*t.moveSpeed*e,t.pos.y+=u*t.moveSpeed*e}}this.useAbilities(e);for(const t of this.entities){if(!t.attack)continue;if((t.stunnedUntil??0)>this.time){t.attack.cd=Math.max(0,t.attack.cd-e);continue}t.attack.cd=Math.max(0,t.attack.cd-e);const s=this.entities.find(i=>i.faction!==t.faction&&i.faction!=="NEUTRAL"&&i.hp>0&&h(t.pos,i.pos)<=t.attack.range);if(s&&t.attack.cd<=0){if(s.hp-=t.attack.damage,t.attack.splash)for(const i of this.entities)i!==s&&(i.faction===t.faction||i.faction==="NEUTRAL"||h(i.pos,s.pos)<=t.attack.splash&&(i.hp-=Math.max(1,Math.floor(t.attack.damage*.4))));t.attack.cd=t.attack.cooldown}}this.updateEffects(e);for(const t of this.entities)t.type==="building"&&t.underConstruction&&(t.constructRemaining=Math.max(0,(t.constructRemaining??0)-e),t.constructRemaining===0&&(t.underConstruction=!1,t.supplyBonus&&(this.economy.supplyCap+=t.supplyBonus)));this.entities=this.entities.filter(t=>t.hp>0||t.type==="resource"),this.processTraining(e),this.harvestAndIncome(e),this.onUpdateExtra&&this.onUpdateExtra(this,e)}render(e){e.save(),e.strokeStyle="#0f172a",e.lineWidth=1;for(let t=0;t<=this.height;t+=8)e.beginPath(),e.moveTo(0,t),e.lineTo(this.width,t),e.stroke();for(let t=0;t<=this.width;t+=8)e.beginPath(),e.moveTo(t,0),e.lineTo(t,this.height),e.stroke();for(const t of this.effects)t.kind==="explosion"?(e.strokeStyle="rgba(239,68,68,0.6)",e.beginPath(),e.arc(t.pos.x,t.pos.y,t.radius,0,Math.PI*2),e.stroke()):t.kind==="stun"&&(e.strokeStyle="rgba(96,165,250,0.6)",e.beginPath(),e.arc(t.pos.x,t.pos.y,t.radius,0,Math.PI*2),e.stroke());for(const t of this.entities)t.type==="resource"&&(e.fillStyle=t.resource.kind==="rubles"?"#3b82f6":"#22c55e",e.beginPath(),e.arc(t.pos.x,t.pos.y,2.5,0,Math.PI*2),e.fill());for(const t of this.entities)t.type==="building"&&(e.fillStyle=t.faction==="SBEU"?"#9333ea":"#ef4444",e.fillRect(t.pos.x-t.radius,t.pos.y-t.radius,t.radius*2,t.radius*2),t.underConstruction&&(e.fillStyle="rgba(248,113,113,0.3)",e.fillRect(t.pos.x-t.radius,t.pos.y-t.radius,t.radius*2,t.radius*2)),D(e,t));for(const t of this.entities)if(t.type==="unit"){const s=(t.stunnedUntil??0)>this.time;e.fillStyle=t.faction==="SBEU"?"#a78bfa":"#f87171",e.globalAlpha=s?.6:1,e.beginPath(),e.arc(t.pos.x,t.pos.y,t.radius,0,Math.PI*2),e.fill(),e.globalAlpha=1,D(e,t)}e.restore()}}function D(n,e){const i=e.pos.x-6,o=e.pos.y-(e.type==="building"?e.radius+4:e.radius+6);n.fillStyle="#111827",n.fillRect(i,o,12,2);const a=Math.max(0,Math.min(1,e.hp/e.hpMax));n.fillStyle=a>.6?"#22c55e":a>.3?"#eab308":"#ef4444",n.fillRect(i,o,12*a,2)}function h(n,e){return Math.hypot(n.x-e.x,n.y-e.y)}class O{canvas;ctx;world;camera={x:0,y:0,zoom:1};mouse={x:0,y:0,worldX:0,worldY:0,down:!1};selectionStart=null;selectedIds=new Set;pendingAbility=null;buildPlacer=null;constructor(e,t){this.canvas=e,this.ctx=t,this.world=new W(128,128),this.world.spawnDemo(),this.bindInput()}loadWorld(e){this.world=e,this.selectedIds.clear(),this.camera={x:0,y:0,zoom:1},this.pendingAbility=null,this.buildPlacer=null}bindInput(){this.canvas.addEventListener("mousemove",e=>{const t=this.canvas.getBoundingClientRect();this.mouse.x=e.clientX-t.left,this.mouse.y=e.clientY-t.top,this.mouse.worldX=this.mouse.x/this.camera.zoom+this.camera.x,this.mouse.worldY=this.mouse.y/this.camera.zoom+this.camera.y}),this.canvas.addEventListener("mousedown",e=>{e.button===0&&(this.mouse.down=!0,this.selectionStart={x:this.mouse.worldX,y:this.mouse.worldY})}),window.addEventListener("mouseup",e=>{if(e.button===0){if(this.mouse.down=!1,this.pendingAbility){this.world.manualCastAbility(this.pendingAbility.casterId,this.pendingAbility.kind,{x:this.mouse.worldX,y:this.mouse.worldY}),this.pendingAbility=null,this.selectionStart=null;return}if(this.buildPlacer){this.world.placeBuilding(this.world.playerFaction,this.buildPlacer.typeId,{x:this.mouse.worldX,y:this.mouse.worldY}),this.buildPlacer=null,this.selectionStart=null;return}this.commitSelection(),this.selectionStart=null}}),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),this.canvas.addEventListener("mouseup",e=>{if(e.button===2){if(this.pendingAbility||this.buildPlacer){this.pendingAbility=null,this.buildPlacer=null;return}const t={x:this.mouse.worldX,y:this.mouse.worldY};this.world.issueMoveCommand([...this.selectedIds],t)}}),window.addEventListener("keydown",e=>{(e.key==="ArrowUp"||e.key==="w")&&(this.camera.y-=32),(e.key==="ArrowDown"||e.key==="s")&&(this.camera.y+=32),(e.key==="ArrowLeft"||e.key==="a")&&(this.camera.x-=32),(e.key==="ArrowRight"||e.key==="d")&&(this.camera.x+=32)}),this.canvas.addEventListener("wheel",e=>{const t=e.deltaY>0?.9:1.1,s=this.screenToWorld(this.mouse.x,this.mouse.y);this.camera.zoom=Math.max(.5,Math.min(2,this.camera.zoom*t));const i=this.screenToWorld(this.mouse.x,this.mouse.y);this.camera.x+=s.x-i.x,this.camera.y+=s.y-i.y},{passive:!0})}screenToWorld(e,t){return{x:e/this.camera.zoom+this.camera.x,y:t/this.camera.zoom+this.camera.y}}commitSelection(){if(!this.selectionStart){const s=this.world.pickEntity(this.mouse.worldX,this.mouse.worldY);this.selectedIds.clear(),s&&this.selectedIds.add(s.id);return}const e=$.fromPoints(this.selectionStart,{x:this.mouse.worldX,y:this.mouse.worldY}),t=this.world.queryEntities(e);this.selectedIds=new Set(t)}update(e){this.world.update(e)}render(){const{ctx:e}=this;if(e.save(),e.clearRect(0,0,this.canvas.width,this.canvas.height),e.scale(this.camera.zoom,this.camera.zoom),e.translate(-this.camera.x,-this.camera.y),this.world.render(e),this.mouse.down&&this.selectionStart&&!this.pendingAbility&&!this.buildPlacer){const t=Math.min(this.selectionStart.x,this.mouse.worldX),s=Math.min(this.selectionStart.y,this.mouse.worldY),i=Math.abs(this.selectionStart.x-this.mouse.worldX),o=Math.abs(this.selectionStart.y-this.mouse.worldY);e.strokeStyle="#60a5fa",e.lineWidth=1,e.strokeRect(t,s,i,o)}if(this.pendingAbility&&(e.strokeStyle="#f59e0b",e.beginPath(),e.arc(this.mouse.worldX,this.mouse.worldY,3,0,Math.PI*2),e.stroke()),this.buildPlacer){const t=this.buildPlacer.typeId,s=this.world.canPlaceBuilding(t,{x:this.mouse.worldX,y:this.mouse.worldY});e.strokeStyle=s?"#22c55e":"#ef4444",e.lineWidth=2;const i=this.world.buildingCatalog[t].radius;e.strokeRect(this.mouse.worldX-i,this.mouse.worldY-i,i*2,i*2)}for(const t of this.selectedIds){const s=this.world.getEntityById(t);s&&(e.strokeStyle="#34d399",e.lineWidth=2,e.beginPath(),e.arc(s.pos.x,s.pos.y,s.radius+2,0,Math.PI*2),e.stroke())}e.restore()}getUIState(){const e=this.world.getEconomy(),t=[...this.selectedIds].map(o=>this.world.getEntityById(o)).filter(Boolean),s=t.length===1?`${t[0].name} (HP ${Math.ceil(t[0].hp)})`:t.length>1?`${t.length} юнитов`:"—",i=[];if(t.length===1&&t[0].type==="building"){const o=t[0];for(const a of this.world.getTrainableUnits(o.faction,o.tier))i.push({id:`train:${a.id}`,label:`Нанять ${a.label}`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>this.world.queueTrain(o.id,a.id)});if(o.faction===this.world.playerFaction){const a=this.world.buildingCatalog.stash;i.push({id:"build:stash",label:`Построить ${a.label}`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>{this.buildPlacer={typeId:"stash"}}})}}if(t.length===1&&t[0].type==="unit"){const o=t[0];if(o.faction===this.world.playerFaction){const a=this.world.buildingCatalog.stash;i.push({id:"build:stash",label:`Построить ${a.label}`,costRubles:a.costRubles,costDollars:a.costDollars,onClick:()=>{this.buildPlacer={typeId:"stash"}}})}o.abilities&&(o.abilities.stunGrenade&&i.push({id:`ab:stun:${o.id}`,label:"Оглушающая граната",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"stunGrenade"}}}),o.abilities.aimedShot&&i.push({id:`ab:aim:${o.id}`,label:"Прицельный выстрел",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"aimedShot"}}}),o.abilities.throwGrenade&&i.push({id:`ab:nade:${o.id}`,label:"Кинуть гранату",costRubles:0,costDollars:0,onClick:()=>{this.pendingAbility={casterId:o.id,kind:"throwGrenade"}}}))}return{rubles:e.rubles,dollars:e.dollars,selectedCount:t.length,inspector:s,objective:this.world.objectiveText,supply:`${this.world.economy.supplyUsed}/${this.world.economy.supplyCap}`,actions:i}}}function b(n,e,t,s){for(const i of s)for(let o=0;o<i.count;o++)n.spawnUnit(e,{x:t.x+(Math.random()*6-3),y:t.y+(Math.random()*6-3)},i.unitId)}function v(n,e){n.objectiveText="Уничтожьте все силы противника",n.winCondition=t=>t.entities.every(s=>s.faction===e||s.faction==="NEUTRAL")}function B(n,e){const t=e*60;n.objectiveText=`Продержитесь ${e} минут`,n.winCondition=s=>s.time>=t}function H(n,e,t){n.objectiveText=`Накопите ресурсы: ₽${e} и $${t}`,n.winCondition=s=>s.getEconomy().rubles>=e&&s.getEconomy().dollars>=t}const _={SBEU:{id:"SBEU",name:"Кампания СБЭУ",missions:[{id:"sbeu-1",name:"Инструктаж зверинца",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),n.objectiveText="Выделяйте юнитов и отдавайте приказы. Постройте пару бойцов",n.onUpdateExtra=(e,t)=>{},n.winCondition=e=>e.entities.filter(t=>t.faction==="SBEU"&&t.type==="unit").length>=10}},{id:"sbeu-2",name:"Отбить ресурсные точки",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo();for(const e of n.entities.filter(t=>t.type==="resource"))b(n,"PMС",{x:e.pos.x+6,y:e.pos.y+6},[{unitId:"pmc-typok",count:3}]);n.objectiveText="Очистите окрестности ресурсов",n.winCondition=e=>e.entities.every(t=>!(t.faction==="PMС"&&t.type==="unit"))}},{id:"sbeu-3",name:"Штурм укрепточки",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),b(n,"PMС",{x:92,y:86},[{unitId:"pmc-silach",count:3},{unitId:"pmc-sniper",count:2}]),v(n,"SBEU")}},{id:"sbeu-4",name:"Накопить на штурм",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),H(n,1e3,300);let e=0;n.onUpdateExtra=(t,s)=>{e+=s,e>20&&(e=0,b(t,"PMС",{x:88,y:92},[{unitId:"pmc-typok",count:4},{unitId:"pmc-grenade",count:1}]))}}},{id:"sbeu-5",name:"Штурм водоочистной",faction:"SBEU",setup:n=>{n.playerFaction="SBEU",n.spawnDemo(),b(n,"PMС",{x:94,y:84},[{unitId:"pmc-silach",count:4},{unitId:"pmc-sniper",count:2},{unitId:"pmc-tank",count:1}]),v(n,"SBEU")}}]},PMC:{id:"PMC",name:"Кампания ЧВК",missions:[{id:"pmc-1",name:"Прибытие Зубешко",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),n.objectiveText="Инструктаж по механикам ЧВК",n.winCondition=e=>e.entities.filter(t=>t.faction==="PMС"&&t.type==="unit").length>=8}},{id:"pmc-2",name:"Оборона укрепления A",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),B(n,3);let e=0;n.onUpdateExtra=(t,s)=>{e+=s,e>15&&(e=0,b(t,"SBEU",{x:60,y:30},[{unitId:"sbeu-worm",count:6},{unitId:"sbeu-caterpillar",count:2}]))}}},{id:"pmc-3",name:"Оборона укрепления B",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),B(n,4);let e=0;n.onUpdateExtra=(t,s)=>{e+=s,e>18&&(e=0,b(t,"SBEU",{x:66,y:52},[{unitId:"sbeu-cockroach",count:3},{unitId:"sbeu-cicada",count:2}]))}}},{id:"pmc-4",name:"Предательство Пуссильченко",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),B(n,5);let e=0;n.onUpdateExtra=(t,s)=>{e+=s,e>20&&(e=0,b(t,"SBEU",{x:70,y:46},[{unitId:"sbeu-worm",count:6},{unitId:"sbeu-cockroach",count:4},{unitId:"sbeu-turtle",count:1}]))}}},{id:"pmc-5",name:"Контрнаступление",faction:"PMС",setup:n=>{n.playerFaction="PMС",n.spawnDemo(),v(n,"PMС")}}]}};function K(n,e){const s=_[n].missions[e],i=new W(128,128);return i.playerFaction=s.faction,s.setup(i),i}const w=document.getElementById("game"),L=w.getContext("2d");function G(){const n=Math.max(1,Math.min(2,window.devicePixelRatio||1));w.width=Math.floor(window.innerWidth*n),w.height=Math.floor(window.innerHeight*n),w.style.width=`${window.innerWidth}px`,w.style.height=`${window.innerHeight}px`,L.setTransform(n,0,0,n,0,0)}G();window.addEventListener("resize",G);const C=new O(w,L);let E="SBEU",M=0;function U(){C.loadWorld(K(E,M))}U();let A=performance.now();function N(n){const e=Math.min(.05,(n-A)/1e3);A=n,C.update(e),C.render(),requestAnimationFrame(N)}requestAnimationFrame(N);const J=document.getElementById("rubles"),V=document.getElementById("dollars"),Z=document.getElementById("supply"),tt=document.getElementById("selected"),et=document.getElementById("inspector"),P=document.getElementById("actions");function it(){const n=C.getUIState();J.textContent=String(n.rubles),V.textContent=String(n.dollars),Z.textContent=n.supply??"0/0",tt.textContent=String(n.selectedCount),et.textContent=n.inspector+(n.objective?` | Цель: ${n.objective}`:""),P.innerHTML="",F(`Кампания: ${E}`,()=>{E=E==="SBEU"?"PMC":"SBEU",M=0,U()}),F(`Миссия ${M+1}/5`,()=>{M=(M+1)%5,U()});for(const e of n.actions){const t=document.createElement("div");t.className="btn",t.textContent=`${e.label} (${e.costRubles}₽/${e.costDollars}$)`,t.onclick=()=>e.onClick(),P.appendChild(t)}}function F(n,e){const t=document.createElement("div");t.className="btn",t.textContent=n,t.onclick=e,P.appendChild(t)}setInterval(it,120);
